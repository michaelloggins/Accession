{% extends "base.html" %}

{% block title %}Admin Panel - Lab Document Intelligence{% endblock %}

{% block extra_css %}
<style>
    /* Admin panel dark mode support */

    /* Cards */
    .card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }

    .card-header {
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .card-body {
        color: var(--text-primary);
    }

    /* Tab navigation */
    .nav-tabs {
        border-bottom-color: var(--border-color);
    }

    .nav-tabs .nav-link {
        color: var(--text-secondary);
        border-color: transparent;
    }

    .nav-tabs .nav-link:hover {
        border-color: var(--border-color) var(--border-color) transparent;
        color: var(--text-primary);
    }

    .nav-tabs .nav-link.active {
        background: var(--bg-secondary);
        border-color: var(--border-color) var(--border-color) var(--bg-secondary);
        color: var(--mv-green);
    }

    /* Forms */
    .form-control, .form-select {
        background-color: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--input-bg);
        border-color: var(--mv-green);
        color: var(--text-primary);
        box-shadow: 0 0 0 3px rgba(139, 197, 63, 0.15);
    }

    .form-label {
        color: var(--text-primary);
    }

    /* Alerts */
    .alert-info {
        background: rgba(59, 130, 246, 0.15);
        border-color: #3b82f6;
        color: var(--text-primary);
    }

    .alert-success {
        background: rgba(139, 197, 63, 0.15);
        border-color: var(--mv-green);
        color: var(--text-primary);
    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.15);
        border-color: var(--warning);
        color: var(--text-primary);
    }

    .alert-danger {
        background: rgba(239, 68, 68, 0.15);
        border-color: var(--danger);
        color: var(--text-primary);
    }

    /* Modal */
    .modal-content {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
    }

    /* List groups */
    .list-group-item {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .list-group-item:hover {
        background: var(--bg-tertiary);
    }

    .list-group-item.active {
        background: var(--mv-green);
        border-color: var(--mv-green);
    }

    /* Status cards - override Bootstrap colors */
    .status-card-queued {
        background: rgba(245, 158, 11, 0.2) !important;
        border: 1px solid var(--warning) !important;
    }

    .status-card-processing {
        background: rgba(59, 130, 246, 0.2) !important;
        border: 1px solid #3b82f6 !important;
    }

    .status-card-success {
        background: rgba(139, 197, 63, 0.2) !important;
        border: 1px solid var(--mv-green) !important;
    }

    .status-card-danger {
        background: rgba(239, 68, 68, 0.2) !important;
        border: 1px solid var(--danger) !important;
    }

    .status-card-queued h2, .status-card-processing h2,
    .status-card-success h2, .status-card-danger h2 {
        color: var(--text-primary) !important;
    }

    /* Timeline */
    .timeline-badge {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Headings */
    h2, h5, h6 {
        color: var(--text-primary);
    }

    /* Text muted */
    .text-muted {
        color: var(--text-secondary) !important;
    }

    /* Code elements */
    code {
        background: var(--bg-tertiary);
        color: var(--mv-green);
        padding: 2px 6px;
        border-radius: 4px;
    }

    /* Identity Provider selection cards */
    .idp-option {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid var(--border-color);
    }

    .idp-option:hover:not(.disabled) {
        border-color: var(--mv-green);
        transform: translateY(-2px);
    }

    .idp-option.selected {
        border-color: var(--mv-green);
        background: rgba(139, 197, 63, 0.1);
    }

    .idp-option.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Card footer for auth cards */
    .card-footer {
        background: var(--bg-tertiary);
        border-top: 1px solid var(--border-color);
    }

    /* Accordion styling for dark mode */
    .accordion-item {
        background: var(--bg-secondary);
        border-color: var(--border-color);
    }

    .accordion-button {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    .accordion-button:not(.collapsed) {
        background: rgba(139, 197, 63, 0.15);
        color: var(--mv-green);
    }

    .accordion-button::after {
        filter: var(--accordion-icon-filter, none);
    }

    [data-theme="dark"] .accordion-button::after {
        filter: invert(1);
    }

    .accordion-body {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-gear"></i> Administration Panel</h2>

        <ul class="nav nav-tabs mt-4" id="adminTabs">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users">
                    <i class="bi bi-people"></i> Users
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#queue">
                    <i class="bi bi-collection"></i> Processing Queue
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#config">
                    <i class="bi bi-sliders"></i> Configuration
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#integrations">
                    <i class="bi bi-plug"></i> Integrations
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reference-data">
                    <i class="bi bi-database"></i> Reference Data
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#audit">
                    <i class="bi bi-journal-text"></i> Audit Logs
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#jobs">
                    <i class="bi bi-clock-history"></i> Background Jobs
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#storage">
                    <i class="bi bi-hdd-stack"></i> Storage Lifecycle
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#equipment">
                    <i class="bi bi-pc-display"></i> Equipment
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#compliance">
                    <i class="bi bi-clipboard-check"></i> Compliance
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- Users Tab -->
            <div class="tab-pane fade show active" id="users">
                <!-- SCIM Status Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-cloud-arrow-down"></i> Entra ID / SCIM Provisioning</h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div id="scimStatus">
                                    <span class="badge bg-secondary">Checking...</span>
                                </div>
                                <small class="text-muted">
                                    SCIM Endpoint: <code id="scimEndpointUrl">/scim/v2</code>
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="testScimEndpoint()">
                                    <i class="bi bi-check-circle"></i> Test SCIM
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="showScimConfigHelp()">
                                    <i class="bi bi-question-circle"></i> Setup Help
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-people"></i> User Management</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="loadUsers()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="bi bi-person-plus"></i> Add Local User
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Auth Provider</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Last Synced</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            <div class="spinner-border spinner-border-sm me-2"></div>
                                            Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Processing Queue Tab -->
            <div class="tab-pane fade" id="queue">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-collection"></i> Document Processing Queue</h5>
                        <div>
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshQueueStatus()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="requeueAllFailed()">
                                <i class="bi bi-arrow-repeat"></i> Requeue All Failed
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Queue Status Cards -->
                        <div class="row mb-4" id="queueStatusCards">
                            <div class="col-md-3">
                                <div class="card status-card-queued">
                                    <div class="card-body text-center">
                                        <h6>Queued</h6>
                                        <h2 id="queuedCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card status-card-processing">
                                    <div class="card-body text-center">
                                        <h6>Processing</h6>
                                        <h2 id="processingCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card status-card-success">
                                    <div class="card-body text-center">
                                        <h6>Extracted</h6>
                                        <h2 id="extractedCount">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card status-card-danger">
                                    <div class="card-body text-center">
                                        <h6>Failed</h6>
                                        <h2 id="failedCount">0</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Service Status -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="alert alert-info" id="workerStatusAlert">
                                    <i class="bi bi-cpu"></i> <strong>Extraction Worker:</strong> <span id="workerStatus">Checking...</span>
                                    <div class="float-end">
                                        <button class="btn btn-sm btn-success me-1" id="startWorkerBtn" onclick="startExtractionWorker()" style="display:none;">
                                            <i class="bi bi-play-fill"></i> Start
                                        </button>
                                        <button class="btn btn-sm btn-danger me-1" id="stopWorkerBtn" onclick="stopExtractionWorker()" style="display:none;">
                                            <i class="bi bi-stop-fill"></i> Stop
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="triggerProcessCycle()" title="Process queued documents now">
                                            <i class="bi bi-lightning"></i> Process Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info" id="blobWatcherStatusAlert">
                                    <i class="bi bi-cloud-arrow-down"></i> <strong>Blob Watcher:</strong> <span id="blobWatcherStatus">Checking...</span>
                                    <span class="ms-2 text-muted" id="blobWatcherDetails"></span>
                                    <div class="float-end">
                                        <button class="btn btn-sm btn-success me-1" id="startBlobWatcherBtn" onclick="startBlobWatcher()" style="display:none;">
                                            <i class="bi bi-play-fill"></i> Start
                                        </button>
                                        <button class="btn btn-sm btn-danger me-1" id="stopBlobWatcherBtn" onclick="stopBlobWatcher()" style="display:none;">
                                            <i class="bi bi-stop-fill"></i> Stop
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="triggerBlobScan()">
                                            <i class="bi bi-search"></i> Scan Now
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Queue Documents Table -->
                        <h6>Documents in Queue</h6>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Accession #</th>
                                        <th>Filename</th>
                                        <th>Status</th>
                                        <th>Batch</th>
                                        <th>Attempts</th>
                                        <th>Queued At</th>
                                        <th>Error</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="queueDocumentsTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Batches Section -->
                        <h6 class="mt-4">Recent Extraction Batches</h6>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Batch ID</th>
                                        <th>Status</th>
                                        <th>Documents</th>
                                        <th>Success/Failed</th>
                                        <th>Attempt</th>
                                        <th>Created</th>
                                        <th>Completed</th>
                                    </tr>
                                </thead>
                                <tbody id="batchesTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div class="tab-pane fade" id="config">
                <!-- Environment Settings Card (Read-only view of Azure App Settings) -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-cloud-fill"></i> Environment Settings (Azure)</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadEnvSettings()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i>
                            These settings are loaded from Azure App Settings. Click the <i class="bi bi-pencil"></i> icon to edit.
                            Changes are applied immediately and logged to the audit trail.
                        </div>
                        <!-- Environment Category Filter -->
                        <div class="mb-3">
                            <label class="form-label">Filter by Category</label>
                            <select class="form-select form-select-sm w-auto" id="envCategoryFilter" onchange="loadEnvSettings()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                        <!-- Environment Settings Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Setting</th>
                                        <th>Current Value</th>
                                        <th>Category</th>
                                        <th>Restart Required</th>
                                        <th style="width: 50px;">Edit</th>
                                    </tr>
                                </thead>
                                <tbody id="envSettingsTable">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Database Configuration Card -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-sliders"></i> System Configuration (Database)</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" onclick="seedConfigs()">
                                <i class="bi bi-database-add"></i> Seed Defaults
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadConfigs()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Category Filter and Expand/Collapse Controls -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <label class="form-label mb-0 me-2">Filter by Category</label>
                                <select class="form-select form-select-sm d-inline-block w-auto" id="configCategoryFilter" onchange="loadConfigs()">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-1" onclick="expandAllConfigs()">
                                    <i class="bi bi-arrows-expand"></i> Expand All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllConfigs()">
                                    <i class="bi bi-arrows-collapse"></i> Collapse All
                                </button>
                            </div>
                        </div>

                        <!-- Configuration Accordion -->
                        <div class="accordion" id="configAccordion">
                            <div class="text-center text-muted py-4">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Integrations Tab -->
            <div class="tab-pane fade" id="integrations">
                <!-- Authentication & Provisioning Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Authentication & User Provisioning</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- SSO Status -->
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="text-muted mb-2">Single Sign-On (SSO)</h6>
                                                <div id="ssoStatusBadge">
                                                    <span class="badge bg-secondary">Checking...</span>
                                                </div>
                                            </div>
                                            <i class="bi bi-microsoft fs-2 text-primary"></i>
                                        </div>
                                        <hr>
                                        <small class="text-muted d-block mb-1">Method: <span id="ssoMethod">-</span></small>
                                        <small class="text-muted d-block mb-1">Tenant ID: <code id="ssoTenantId" class="small">-</code></small>
                                        <small class="text-muted d-block">Client ID: <code id="ssoClientId" class="small">-</code></small>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showSsoConfigModal()">
                                            <i class="bi bi-gear"></i> Configure
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="testSsoConnection()">
                                            <i class="bi bi-check-circle"></i> Test
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- SCIM Provisioning Status -->
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="text-muted mb-2">SCIM Provisioning</h6>
                                                <div id="scimStatusBadgeInteg">
                                                    <span class="badge bg-secondary">Checking...</span>
                                                </div>
                                            </div>
                                            <i class="bi bi-people fs-2 text-success"></i>
                                        </div>
                                        <hr>
                                        <small class="text-muted d-block mb-1">Endpoint: <code class="small">/scim/v2</code></small>
                                        <small class="text-muted d-block mb-1">Users synced: <span id="scimUserCount">-</span></small>
                                        <small class="text-muted d-block">Last sync: <span id="scimLastSync">-</span></small>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showScimConfigModal()">
                                            <i class="bi bi-gear"></i> Configure
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="testScimEndpointInteg()">
                                            <i class="bi bi-check-circle"></i> Test
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Group Mapping -->
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="text-muted mb-2">Role Mapping</h6>
                                                <div id="roleMappingStatus">
                                                    <span class="badge bg-secondary">Checking...</span>
                                                </div>
                                            </div>
                                            <i class="bi bi-diagram-3 fs-2 text-warning"></i>
                                        </div>
                                        <hr>
                                        <small class="text-muted d-block mb-1">Admin Group: <span id="adminGroupStatus" class="badge bg-secondary">-</span></small>
                                        <small class="text-muted d-block mb-1">Reviewer Group: <span id="reviewerGroupStatus" class="badge bg-secondary">-</span></small>
                                        <small class="text-muted d-block">User Group: <span id="userGroupStatus" class="badge bg-secondary">-</span></small>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showRoleMappingModal()">
                                            <i class="bi bi-gear"></i> Configure
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Help -->
                        <div class="alert alert-info mt-3 mb-0">
                            <i class="bi bi-info-circle"></i>
                            <strong>Setup Guide:</strong>
                            To configure Entra ID SSO and SCIM provisioning, you'll need to create an Enterprise Application in Azure AD.
                            <a href="#" onclick="showAuthSetupGuide(); return false;">View full setup guide</a>
                        </div>
                    </div>
                </div>

                <!-- AI Services Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot"></i> AI Services</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Azure Document Intelligence -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="text-muted mb-2">Azure Document Intelligence</h6>
                                                <div id="docIntelStatusBadge">
                                                    <span class="badge bg-secondary">Checking...</span>
                                                </div>
                                            </div>
                                            <i class="bi bi-file-earmark-text fs-2 text-info"></i>
                                        </div>
                                        <hr>
                                        <small class="text-muted d-block mb-2">Document classification and separation</small>

                                        <!-- Capabilities Checkboxes -->
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="docIntelClassify" onchange="saveAiServiceConfig()">
                                                <label class="form-check-label" for="docIntelClassify">
                                                    <strong>Classify / Split</strong>
                                                    <small class="d-block text-muted">Separate multi-page scans into individual documents</small>
                                                </label>
                                            </div>
                                        </div>

                                        <small class="text-muted d-block mb-1">Endpoint: <code id="docIntelEndpoint" class="small">-</code></small>
                                        <small class="text-muted d-block mb-2">Classifier: <code id="docIntelClassifier" class="small">-</code></small>

                                        <!-- Training Stats -->
                                        <div class="border-top pt-2 mt-2">
                                            <small class="text-muted">Training samples: <strong id="docIntelTrainingSamples">0</strong></small>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showDocIntelConfigModal()">
                                            <i class="bi bi-gear"></i> Configure
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="testDocIntelConnection()">
                                            <i class="bi bi-check-circle"></i> Test
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Azure OpenAI -->
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="text-muted mb-2">Azure OpenAI (GPT-4 Vision)</h6>
                                                <div id="openAiStatusBadge">
                                                    <span class="badge bg-secondary">Checking...</span>
                                                </div>
                                            </div>
                                            <i class="bi bi-stars fs-2 text-purple" style="color: #6f42c1;"></i>
                                        </div>
                                        <hr>
                                        <small class="text-muted d-block mb-2">Data extraction from documents</small>

                                        <!-- Capabilities Checkboxes -->
                                        <div class="mb-2">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="openAiExtract" onchange="saveAiServiceConfig()">
                                                <label class="form-check-label" for="openAiExtract">
                                                    <strong>Extract</strong>
                                                    <small class="d-block text-muted">Extract patient data, tests, and facility info from documents</small>
                                                </label>
                                            </div>
                                        </div>

                                        <small class="text-muted d-block mb-1">Endpoint: <code id="openAiEndpoint" class="small">-</code></small>
                                        <small class="text-muted d-block">Deployment: <code id="openAiDeployment" class="small">-</code></small>
                                    </div>
                                    <div class="card-footer">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showOpenAiConfigModal()">
                                            <i class="bi bi-gear"></i> Configure
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="testOpenAiConnection()">
                                            <i class="bi bi-check-circle"></i> Test
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Mode Section -->
                        <div class="card mt-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1"><i class="bi bi-mortarboard"></i> Learning Mode</h6>
                                        <small class="text-muted">When enabled, GPT-4 Vision analyzes documents to train the classifier</small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="learningModeToggle" onchange="saveAiServiceConfig()" style="transform: scale(1.5);">
                                    </div>
                                </div>

                                <div id="learningModeDetails" class="mt-3" style="display: none;">
                                    <div class="row g-2">
                                        <div class="col-md-3">
                                            <div class="border rounded p-2 text-center">
                                                <div class="fs-4 fw-bold text-primary" id="learnedDocTypes">0</div>
                                                <small class="text-muted">Document Types</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border rounded p-2 text-center">
                                                <div class="fs-4 fw-bold text-success" id="learnedSamples">0</div>
                                                <small class="text-muted">Training Samples</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border rounded p-2 text-center">
                                                <div class="fs-4 fw-bold text-info" id="learnedFeatures">0</div>
                                                <small class="text-muted">Learned Features</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="border rounded p-2 text-center">
                                                <div class="fs-4 fw-bold text-warning" id="frExtractionPct">0%</div>
                                                <small class="text-muted">FR Extraction Rate</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showDocumentTypesPanel()">
                                            <i class="bi bi-list-ul"></i> Manage Document Types
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="exportTrainingData()">
                                            <i class="bi bi-download"></i> Export Training Data
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearTrainingData()">
                                            <i class="bi bi-trash"></i> Clear Data
                                        </button>
                                    </div>
                                    <div class="mt-3 pt-3 border-top" id="trainClassifierSection" style="display: none;">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <strong><i class="bi bi-cpu"></i> Ready to Train?</strong>
                                                <div class="small text-muted" id="trainingReadiness">
                                                    Minimum 5 samples across at least 1 document type required.
                                                </div>
                                            </div>
                                            <button class="btn btn-warning" id="trainClassifierBtn" onclick="trainClassifierAndDisable()" disabled>
                                                <i class="bi bi-mortarboard-fill"></i> Train Classifier & Disable Learning
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Workflow Info -->
                        <div class="alert alert-light mt-3 mb-0 border">
                            <i class="bi bi-diagram-2"></i>
                            <strong>Processing Workflow:</strong>
                            <span class="ms-2">
                                <span class="badge bg-info">Scan</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="badge bg-info">Doc Intelligence (Classify/Split)</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="badge bg-purple" style="background-color: #6f42c1 !important;">OpenAI (Extract)</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="badge bg-success">Review Queue</span>
                            </span>
                            <span id="learningBadge" class="ms-2" style="display: none;">
                                <span class="badge bg-warning text-dark"><i class="bi bi-mortarboard"></i> Learning</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Integration List -->
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-plug"></i> Integrations</h5>
                                <button class="btn btn-primary btn-sm" onclick="showAddIntegrationModal()">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="integrationsList">
                                    <div class="text-center p-3 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading integrations...
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- API Keys Card -->
                        <div class="card mt-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-key"></i> API Keys</h6>
                                <button class="btn btn-outline-primary btn-sm" onclick="showCreateApiKeyModal()">
                                    <i class="bi bi-plus"></i> Create Key
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="apiKeysList" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-center p-2 text-muted small">No API keys yet</div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Integration Details -->
                    <div class="col-md-8">
                        <div class="card" id="integrationDetailCard" style="display: none;">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="mb-0" id="integrationDetailName">Integration Details</h5>
                                        <small class="text-muted" id="integrationDetailType"></small>
                                    </div>
                                    <div>
                                        <span class="badge" id="integrationDetailStatus">pending</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Tabs for integration sections -->
                                <ul class="nav nav-tabs" role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#intConfig">
                                            <i class="bi bi-gear"></i> Configuration
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#intMapping">
                                            <i class="bi bi-diagram-3"></i> Field Mapping
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#intTest">
                                            <i class="bi bi-play-circle"></i> Test Sample
                                        </button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#intLogs">
                                            <i class="bi bi-journal-text"></i> Logs
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content mt-3">
                                    <!-- Configuration Tab -->
                                    <div class="tab-pane fade show active" id="intConfig">
                                        <div class="alert alert-info" id="azureRecommendation" style="display: none;">
                                            <i class="bi bi-lightbulb"></i> <strong>Azure Recommendation:</strong>
                                            <span id="azureRecommendationText"></span>
                                        </div>

                                        <form id="integrationConfigForm">
                                            <div id="configFieldsContainer">
                                                <!-- Dynamic config fields rendered here -->
                                            </div>

                                            <hr>
                                            <div class="mb-3">
                                                <label class="form-label">Webhook URL</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="webhookUrl" readonly>
                                                    <button class="btn btn-outline-secondary" type="button" onclick="copyWebhookUrl()">
                                                        <i class="bi bi-clipboard"></i>
                                                    </button>
                                                </div>
                                                <small class="text-muted">Use this URL in Logic Apps or Azure Functions to send data</small>
                                            </div>

                                            <div class="d-flex justify-content-between">
                                                <button type="button" class="btn btn-primary" onclick="saveIntegrationConfig()">
                                                    <i class="bi bi-check-lg"></i> Save Configuration
                                                </button>
                                                <div>
                                                    <button type="button" class="btn btn-success" id="activateBtn" onclick="activateIntegration()">
                                                        <i class="bi bi-play-fill"></i> Activate
                                                    </button>
                                                    <button type="button" class="btn btn-warning" id="deactivateBtn" onclick="deactivateIntegration()" style="display: none;">
                                                        <i class="bi bi-pause-fill"></i> Deactivate
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" onclick="deleteIntegration()">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>

                                    <!-- Field Mapping Tab -->
                                    <div class="tab-pane fade" id="intMapping">
                                        <p class="text-muted mb-3">Map fields from the integration source to document fields. Use the Test Sample tab to see available source fields.</p>
                                        <form id="fieldMappingForm">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Document Field</th>
                                                        <th>Source Field</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="fieldMappingBody">
                                                    <!-- Dynamic mapping rows -->
                                                </tbody>
                                            </table>
                                            <button type="button" class="btn btn-primary" onclick="saveFieldMapping()">
                                                <i class="bi bi-check-lg"></i> Save Mapping
                                            </button>
                                        </form>
                                    </div>

                                    <!-- Test Sample Tab -->
                                    <div class="tab-pane fade" id="intTest">
                                        <div class="mb-3">
                                            <label class="form-label">Paste Sample Data</label>
                                            <textarea class="form-control" id="sampleDataInput" rows="6" placeholder="Paste CSV or JSON sample data here..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Or Upload Sample File</label>
                                            <input type="file" class="form-control" id="sampleFileInput" accept=".csv,.json,.txt">
                                        </div>
                                        <button class="btn btn-primary" onclick="testSample()">
                                            <i class="bi bi-play-circle"></i> Test Sample
                                        </button>

                                        <div id="sampleResults" class="mt-3" style="display: none;">
                                            <h6>Test Results</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header">Detected Fields</div>
                                                        <div class="card-body">
                                                            <ul id="detectedFields" class="list-unstyled small mb-0"></ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card">
                                                        <div class="card-header">Mapped Result</div>
                                                        <div class="card-body">
                                                            <pre id="mappedResult" class="small mb-0" style="max-height: 200px; overflow-y: auto;"></pre>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Logs Tab -->
                                    <div class="tab-pane fade" id="intLogs">
                                        <div class="mb-3">
                                            <strong>Statistics:</strong>
                                            <span class="badge bg-primary" id="statReceived">0 received</span>
                                            <span class="badge bg-success" id="statProcessed">0 processed</span>
                                            <span class="badge bg-danger" id="statErrors">0 errors</span>
                                        </div>
                                        <div class="table-responsive" style="max-height: 300px;">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Time</th>
                                                        <th>Event</th>
                                                        <th>Status</th>
                                                        <th>Details</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="integrationLogsBody">
                                                    <tr><td colspan="4" class="text-center text-muted">No logs yet</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- No Selection State -->
                        <div class="card" id="noIntegrationSelected">
                            <div class="card-body text-center py-5">
                                <i class="bi bi-plug display-1 text-muted"></i>
                                <h5 class="text-muted mt-3">Select an Integration</h5>
                                <p class="text-muted">Choose an integration from the list or create a new one</p>
                                <button class="btn btn-primary" onclick="showAddIntegrationModal()">
                                    <i class="bi bi-plus-circle"></i> Add New Integration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reference Data Tab -->
            <div class="tab-pane fade" id="reference-data">
                <!-- Species Management Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-bug"></i> Species Management</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddSpeciesModal()">
                            <i class="bi bi-plus-circle"></i> Add Species
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            Define the species available for testing. Species determines which tests are applicable and affects patient data entry.
                        </p>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Common Name</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="speciesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            Loading species...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Test Catalog Section -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-clipboard2-check"></i> Test Catalog</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddTestModal()">
                            <i class="bi bi-plus-circle"></i> Add Test
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Filter Row -->
                        <div class="row mb-3 g-2">
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm" id="filterTestCode" placeholder="Filter Code...">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control form-control-sm" id="filterTestName" placeholder="Filter Name...">
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filterTestType">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filterSpecies">
                                    <option value="">All Species</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="filterSpecimen">
                                    <option value="">All Specimens</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearTestFilters()" title="Clear Filters">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th style="cursor: pointer;" onclick="sortTestsBy('test_number')">
                                            Test Code <i class="bi bi-arrow-down-up" id="sort-test_number"></i>
                                        </th>
                                        <th style="cursor: pointer;" onclick="sortTestsBy('test_name')">
                                            Test Name <i class="bi bi-arrow-down-up" id="sort-test_name"></i>
                                        </th>
                                        <th style="cursor: pointer;" onclick="sortTestsBy('test_type')">
                                            Test Type <i class="bi bi-arrow-down-up" id="sort-test_type"></i>
                                        </th>
                                        <th style="cursor: pointer;" onclick="sortTestsBy('species')">
                                            Species <i class="bi bi-arrow-down-up" id="sort-species"></i>
                                        </th>
                                        <th>Eligible Specimens</th>
                                        <th style="cursor: pointer;" onclick="sortTestsBy('minimum_sample_ml')">
                                            Min Sample <i class="bi bi-arrow-down-up" id="sort-minimum_sample_ml"></i>
                                        </th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="testsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            Loading tests...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Tab -->
            <div class="tab-pane fade" id="audit">
                <!-- Audit Controls -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="bi bi-funnel"></i> Audit Log Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control form-control-sm" id="auditStartDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control form-control-sm" id="auditEndDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">User</label>
                                <input type="text" class="form-control form-control-sm" id="auditUserFilter" placeholder="Email...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Action</label>
                                <select class="form-select form-select-sm" id="auditActionFilter">
                                    <option value="">All Actions</option>
                                    <option value="LOGIN">Login</option>
                                    <option value="LOGOUT">Logout</option>
                                    <option value="CREATE">Create</option>
                                    <option value="VIEW">View</option>
                                    <option value="UPDATE">Update</option>
                                    <option value="DELETE">Delete</option>
                                    <option value="APPROVE">Approve</option>
                                    <option value="EXPORT">Export</option>
                                    <option value="QUEUE_REEXTRACT">Re-extract</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Resource</label>
                                <select class="form-select form-select-sm" id="auditResourceFilter">
                                    <option value="">All Resources</option>
                                    <option value="DOCUMENT">Document</option>
                                    <option value="USER">User</option>
                                    <option value="SESSION">Session</option>
                                    <option value="CONFIG">Config</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Limit</label>
                                <select class="form-select form-select-sm" id="auditLimitFilter">
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                    <option value="250">250</option>
                                    <option value="500">500</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary btn-sm" onclick="loadAuditLogs()">
                                    <i class="bi bi-search"></i> Search
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearAuditFilters()">
                                    <i class="bi bi-x-circle"></i> Clear Filters
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="exportAuditLogs()">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                                <span class="ms-3 text-muted" id="auditLogCount"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-journal-text"></i> Audit Logs</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="loadAuditLogs()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="sticky-top">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>User</th>
                                        <th>Action</th>
                                        <th>Resource</th>
                                        <th>PHI Accessed</th>
                                        <th>Status</th>
                                        <th>IP</th>
                                    </tr>
                                </thead>
                                <tbody id="auditLogTable">
                                    <tr>
                                        <td colspan="7" class="text-center">Loading audit logs...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Background Jobs Tab -->
            <div class="tab-pane fade" id="jobs">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-clock-history"></i> Background Jobs Monitor</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshJobs()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Background jobs are created when uploading more than 4 files at once. Each file is uploaded, extracted, and saved individually with progress tracking. You can cancel jobs or retry failed files.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 20%;">Job ID</th>
                                        <th style="width: 10%;">Status</th>
                                        <th style="width: 15%;">Progress</th>
                                        <th style="width: 15%;">Files</th>
                                        <th style="width: 15%;">Started</th>
                                        <th style="width: 15%;">Completed</th>
                                        <th style="width: 10%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="jobsTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">No background jobs found</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Job Details Panel -->
                        <div id="jobDetailsPanel" class="mt-4" style="display: none;">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">Job Details: <span id="detailJobId"></span></h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Status:</strong> <span id="detailStatus"></span></p>
                                            <p><strong>Total Files:</strong> <span id="detailTotalFiles"></span></p>
                                            <p><strong>Processed:</strong> <span id="detailProcessed"></span></p>
                                            <p><strong>Successful:</strong> <span id="detailSuccessful"></span></p>
                                            <p><strong>Failed:</strong> <span id="detailFailed"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Started:</strong> <span id="detailStarted"></span></p>
                                            <p><strong>Completed:</strong> <span id="detailCompleted"></span></p>
                                            <p><strong>Duration:</strong> <span id="detailDuration"></span></p>
                                            <p><strong>Error:</strong> <span id="detailError" class="text-danger"></span></p>
                                        </div>
                                    </div>

                                    <!-- Results List -->
                                    <div class="mt-3">
                                        <h6>Processing Results:</h6>
                                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Filename</th>
                                                        <th>Status</th>
                                                        <th>Accession #</th>
                                                        <th>Confidence</th>
                                                        <th>Error</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="jobResultsTableBody">
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Storage Lifecycle Tab -->
            <div class="tab-pane fade" id="storage">
                <div class="row">
                    <!-- Current Configuration Card -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="bi bi-gear"></i> Retention & Tiering Settings</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="loadLifecycleConfig()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> These settings control document retention and automatic storage tier transitions.
                                    Changes take effect immediately for new documents. Use "Sync All" to update existing documents.
                                </div>

                                <!-- Retention Settings -->
                                <h6 class="border-bottom pb-2"><i class="bi bi-calendar-check"></i> Document Retention</h6>
                                <div class="mb-3 row">
                                    <label class="col-sm-6 col-form-label">Retention Period (Years)</label>
                                    <div class="col-sm-6">
                                        <input type="number" class="form-control" id="retentionYears" min="1" max="99">
                                        <small class="text-muted">Documents become deletable after this period + 1 day</small>
                                    </div>
                                </div>

                                <!-- Tiering Settings -->
                                <h6 class="border-bottom pb-2 mt-4"><i class="bi bi-thermometer-half"></i> Storage Tiering</h6>
                                <div class="mb-3 row">
                                    <label class="col-sm-6 col-form-label">Move to Cool Tier (Days)</label>
                                    <div class="col-sm-6">
                                        <input type="number" class="form-control" id="coolTierDays" min="1" max="365">
                                        <small class="text-muted">Days after upload before moving to Cool storage</small>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-6 col-form-label">Move to Cold Tier (Days)</label>
                                    <div class="col-sm-6">
                                        <input type="number" class="form-control" id="coldTierDays" min="1" max="3650">
                                        <small class="text-muted">Days after upload before moving to Cold storage</small>
                                    </div>
                                </div>

                                <!-- Immutability Settings -->
                                <h6 class="border-bottom pb-2 mt-4"><i class="bi bi-lock"></i> WORM Compliance</h6>
                                <div class="mb-3 row">
                                    <label class="col-sm-6 col-form-label">Immutability Enabled</label>
                                    <div class="col-sm-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="immutabilityEnabled">
                                            <label class="form-check-label" for="immutabilityEnabled">
                                                Write Once Read Many (WORM)
                                            </label>
                                        </div>
                                        <small class="text-muted">Prevents modification/deletion until expiry</small>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-6 col-form-label">Auto-Sync to Azure</label>
                                    <div class="col-sm-6">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoSyncEnabled">
                                            <label class="form-check-label" for="autoSyncEnabled">
                                                Sync lifecycle policy changes
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-primary mt-3" onclick="saveLifecycleSettings()">
                                    <i class="bi bi-check-lg"></i> Save Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Example Calculations Card -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-calculator"></i> Lifecycle Timeline Preview</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Based on current settings, a document uploaded today would follow this timeline:</p>

                                <div class="timeline" id="lifecycleTimeline">
                                    <div class="timeline-item">
                                        <div class="timeline-badge bg-success"><i class="bi bi-upload"></i></div>
                                        <div class="timeline-content">
                                            <h6>Document Uploaded</h6>
                                            <p class="mb-1" id="timeline-upload">Today</p>
                                            <small class="text-muted">Storage: Hot tier</small>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-badge bg-info"><i class="bi bi-snow"></i></div>
                                        <div class="timeline-content">
                                            <h6>Move to Cool Storage</h6>
                                            <p class="mb-1" id="timeline-cool">Loading...</p>
                                            <small class="text-muted">Lower cost, infrequent access</small>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-badge bg-primary"><i class="bi bi-snow3"></i></div>
                                        <div class="timeline-content">
                                            <h6>Move to Cold Storage</h6>
                                            <p class="mb-1" id="timeline-cold">Loading...</p>
                                            <small class="text-muted">Lowest cost, rare access</small>
                                        </div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-badge bg-warning"><i class="bi bi-unlock"></i></div>
                                        <div class="timeline-content">
                                            <h6>Immutability Expires</h6>
                                            <p class="mb-1" id="timeline-expiry">Loading...</p>
                                            <small class="text-muted">Document becomes deletable</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sync Actions Card -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5><i class="bi bi-arrow-repeat"></i> Sync Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="syncAllMetadata()">
                                        <i class="bi bi-cloud-upload"></i> Sync All Document Metadata
                                    </button>
                                    <small class="text-muted text-center">Updates all blob metadata with current settings and extracted data</small>

                                    <button class="btn btn-outline-secondary mt-2" onclick="generateLifecyclePolicy()">
                                        <i class="bi bi-file-earmark-code"></i> Generate Lifecycle Policy
                                    </button>
                                    <small class="text-muted text-center">Generates Azure Blob lifecycle policy JSON for manual apply</small>
                                </div>

                                <!-- Sync Results -->
                                <div id="syncResults" class="mt-3" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6>Sync Results:</h6>
                                        <pre id="syncResultsContent" class="mb-0" style="max-height: 200px; overflow-y: auto;"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Tab -->
            <div class="tab-pane fade" id="equipment">
                <div class="row">
                    <!-- Scanning Stations Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="bi bi-upc-scan"></i> Scanning Stations</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="loadScanningStations()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="showAddStationModal()">
                                        <i class="bi bi-plus-circle"></i> Add Station
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Location</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stationsTableBody">
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Label Printers Card -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5><i class="bi bi-printer"></i> Label Printers</h5>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="loadLabelPrinters()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="showAddPrinterModal()">
                                        <i class="bi bi-plus-circle"></i> Add Printer
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Location</th>
                                                <th>Type</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="printersTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">Loading...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Compliance Tab -->
            <div class="tab-pane fade" id="compliance">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Compliance Reports</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">Access compliance reports, audit logs, and regulatory documentation.</p>

                        <div class="row g-4">
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-file-earmark-text fs-1 text-primary mb-3"></i>
                                        <h6>HIPAA Compliance</h6>
                                        <p class="small text-muted">View HIPAA audit reports and access logs</p>
                                        <a href="/compliance" class="btn btn-outline-primary btn-sm">View Reports</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-shield-check fs-1 text-success mb-3"></i>
                                        <h6>Access Audit</h6>
                                        <p class="small text-muted">Review user access patterns and PHI views</p>
                                        <a href="/compliance#access-audit" class="btn btn-outline-success btn-sm">View Audit</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-download fs-1 text-info mb-3"></i>
                                        <h6>Export Reports</h6>
                                        <p class="small text-muted">Download compliance reports for auditors</p>
                                        <a href="/compliance#export" class="btn btn-outline-info btn-sm">Export</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="text-center">
                            <a href="/compliance" class="btn btn-primary">
                                <i class="bi bi-box-arrow-up-right"></i> Open Full Compliance Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

<!-- Scanning Station Modal -->
<div class="modal fade" id="stationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upc-scan"></i> <span id="stationModalTitle">Add Scanning Station</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="stationId">
                <div class="mb-3">
                    <label class="form-label">Station Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="stationName" placeholder="e.g., Front Desk Scanner">
                </div>
                <div class="mb-3">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="stationLocation" placeholder="e.g., Reception Area">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="stationDescription" rows="2" placeholder="Optional notes about this station"></textarea>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="stationActive" checked>
                    <label class="form-check-label" for="stationActive">Active</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStation()">
                    <i class="bi bi-check-lg"></i> Save Station
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Label Printer Modal -->
<div class="modal fade" id="printerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-printer"></i> <span id="printerModalTitle">Add Label Printer</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="printerId">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Printer Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="printerName" placeholder="e.g., Lab Label Printer">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="printerLocation" placeholder="e.g., Lab Workstation 1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Printer Type</label>
                            <select class="form-select" id="printerType">
                                <option value="">Select type...</option>
                                <option value="Zebra">Zebra (ZPL)</option>
                                <option value="DYMO">DYMO</option>
                                <option value="Brother">Brother</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Print Method</label>
                            <select class="form-select" id="printerMethod" onchange="togglePrinterMethodFields()">
                                <option value="universal_print">Universal Print (Cloud)</option>
                                <option value="direct_ip">Direct IP (Port 9100)</option>
                                <option value="local">Local/USB</option>
                            </select>
                            <small class="text-muted">How to send print jobs to this printer</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Universal Print Settings -->
                        <div id="universalPrintFields">
                            <div class="mb-3">
                                <label class="form-label"><i class="bi bi-cloud"></i> Universal Print ID</label>
                                <input type="text" class="form-control" id="printerUniversalPrintId" placeholder="Microsoft Graph printer ID">
                                <small class="text-muted">From Microsoft Universal Print portal</small>
                            </div>
                        </div>
                        <!-- Direct IP Settings -->
                        <div id="directIpFields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">IP Address / Connection String</label>
                                <input type="text" class="form-control" id="printerConnection" placeholder="e.g., 192.168.1.100">
                                <small class="text-muted">Network address for direct printing</small>
                            </div>
                        </div>
                        <!-- Label Size Settings -->
                        <div class="mb-3">
                            <label class="form-label">Label Size</label>
                            <div class="row g-2">
                                <div class="col-5">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="printerLabelWidth" value="2" placeholder="Width">
                                        <span class="input-group-text">"</span>
                                    </div>
                                </div>
                                <div class="col-2 text-center pt-2">x</div>
                                <div class="col-5">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="printerLabelHeight" value="1" placeholder="Height">
                                        <span class="input-group-text">"</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Printer DPI</label>
                            <select class="form-select" id="printerDpi">
                                <option value="203">203 DPI (Standard)</option>
                                <option value="300">300 DPI (High Resolution)</option>
                            </select>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="printerActive" checked>
                            <label class="form-check-label" for="printerActive">Active</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="testPrinterConnection()">
                    <i class="bi bi-check-circle"></i> Test Connection
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePrinter()">
                    <i class="bi bi-check-lg"></i> Save Printer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Identity Provider Configuration Modal -->
<div class="modal fade" id="ssoConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-shield-lock"></i> SSO Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Identity Provider Selection -->
                <div class="mb-4">
                    <label class="form-label">Identity Provider</label>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <div class="card idp-option selected" data-idp="entra" onclick="selectIdp('entra')">
                                <div class="card-body text-center py-3">
                                    <i class="bi bi-microsoft fs-2 text-primary"></i>
                                    <div class="mt-2 fw-bold">Microsoft Entra ID</div>
                                    <small class="text-muted">Azure AD</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card idp-option disabled" data-idp="google" title="Coming soon">
                                <div class="card-body text-center py-3 opacity-50">
                                    <i class="bi bi-google fs-2 text-danger"></i>
                                    <div class="mt-2 fw-bold">Google Workspace</div>
                                    <small class="text-muted">Coming soon</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card idp-option disabled" data-idp="okta" title="Coming soon">
                                <div class="card-body text-center py-3 opacity-50">
                                    <svg class="fs-2" width="32" height="32" viewBox="0 0 24 24" fill="#007dc1">
                                        <path d="M12 0C5.389 0 0 5.389 0 12s5.389 12 12 12 12-5.389 12-12S18.611 0 12 0zm0 18c-3.314 0-6-2.686-6-6s2.686-6 6-6 6 2.686 6 6-2.686 6-6 6z"/>
                                    </svg>
                                    <div class="mt-2 fw-bold">Okta</div>
                                    <small class="text-muted">Coming soon</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card idp-option disabled" data-idp="onelogin" title="Coming soon">
                                <div class="card-body text-center py-3 opacity-50">
                                    <i class="bi bi-key fs-2 text-info"></i>
                                    <div class="mt-2 fw-bold">OneLogin</div>
                                    <small class="text-muted">Coming soon</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Entra ID Configuration -->
                <div id="entraConfig">
                    <h6 class="border-bottom pb-2 mb-3">Microsoft Entra ID Configuration</h6>

                    <div class="mb-3">
                        <label class="form-label">Authentication Method</label>
                        <select class="form-select" id="ssoMethodSelect">
                            <option value="saml">SAML 2.0 (Recommended)</option>
                            <option value="oidc">OpenID Connect (OIDC)</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tenant ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ssoTenantIdInput" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <small class="text-muted">Found in Azure AD  Overview</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Client ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="ssoClientIdInput" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <small class="text-muted">App Registration  Application ID</small>
                        </div>
                    </div>

                    <div class="mb-3" id="clientSecretGroup">
                        <label class="form-label">Client Secret <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="ssoClientSecretInput" placeholder="Enter client secret">
                        <small class="text-muted">App Registration  Certificates & secrets</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Redirect URI</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="ssoRedirectUri" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('ssoRedirectUri')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <small class="text-muted">Add this to your App Registration  Authentication</small>
                    </div>

                    <!-- SAML-specific fields -->
                    <div id="samlFields">
                        <h6 class="border-bottom pb-2 mb-3 mt-4">SAML Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">Entity ID (Identifier)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="samlEntityId" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('samlEntityId')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reply URL (ACS URL)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="samlAcsUrl" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('samlAcsUrl')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">IdP Metadata URL (from Azure)</label>
                            <input type="text" class="form-control" id="samlMetadataUrl" placeholder="https://login.microsoftonline.com/...">
                            <small class="text-muted">Enterprise App  Single sign-on  Federation Metadata XML</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-shield-lock"></i> SAML Token Signing Certificate (Base64)</label>
                            <textarea class="form-control font-monospace" id="samlIdpCert" rows="5" placeholder="Paste the certificate content here (Base64 encoded, without BEGIN/END CERTIFICATE headers)"></textarea>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Download from: Entra ID  Enterprise App  Single sign-on  SAML Certificates  Download <strong>"Certificate (Base64)"</strong>
                            </small>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mt-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> Changes will require environment variable updates or Key Vault configuration.
                    Configuration values can be saved to the database for reference, but sensitive values should be stored securely.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSsoConfig()">
                    <i class="bi bi-check-lg"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- SCIM Configuration Modal -->
<div class="modal fade" id="scimConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-people"></i> SCIM Provisioning Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    SCIM (System for Cross-domain Identity Management) enables automatic user provisioning from your identity provider.
                </div>

                <h6 class="border-bottom pb-2 mb-3">SCIM Endpoint Configuration</h6>

                <div class="mb-3">
                    <label class="form-label">Tenant URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="scimTenantUrl" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('scimTenantUrl')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    <small class="text-muted">Use this URL in your IdP's SCIM provisioning configuration</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Secret Token</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="scimSecretToken" placeholder="Enter or generate a secure token">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('scimSecretToken')">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" type="button" onclick="generateScimToken()">
                            <i class="bi bi-arrow-repeat"></i> Generate
                        </button>
                    </div>
                    <small class="text-muted">This token authenticates SCIM requests from your IdP</small>
                </div>

                <h6 class="border-bottom pb-2 mb-3 mt-4">Entra ID Setup Instructions</h6>
                <ol class="small">
                    <li>Go to <strong>Azure Portal</strong>  <strong>Enterprise Applications</strong></li>
                    <li>Select your application (or create a new one)</li>
                    <li>Go to <strong>Provisioning</strong>  <strong>Get started</strong></li>
                    <li>Set <strong>Provisioning Mode</strong> to <strong>Automatic</strong></li>
                    <li>Enter the <strong>Tenant URL</strong> and <strong>Secret Token</strong> from above</li>
                    <li>Click <strong>Test Connection</strong> to verify</li>
                    <li>Configure <strong>Mappings</strong> for Users (and optionally Groups)</li>
                    <li>Set <strong>Provisioning Status</strong> to <strong>On</strong></li>
                </ol>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveScimConfig()">
                    <i class="bi bi-check-lg"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Role Mapping Modal -->
<div class="modal fade" id="roleMappingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-diagram-3"></i> Role Mapping Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Map Azure AD Security Groups to application roles. Users will be assigned roles based on their group membership.
                </div>

                <div class="mb-3">
                    <label class="form-label">Admin Group ID</label>
                    <input type="text" class="form-control" id="adminGroupId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    <small class="text-muted">Members get full admin access</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Reviewer Group ID</label>
                    <input type="text" class="form-control" id="reviewerGroupId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    <small class="text-muted">Members can review and approve documents</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">User Group ID</label>
                    <input type="text" class="form-control" id="userGroupId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                    <small class="text-muted">Members have read-only access</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Default Role (if no group match)</label>
                    <select class="form-select" id="defaultRole">
                        <option value="read_only">Read Only</option>
                        <option value="reviewer">Reviewer</option>
                        <option value="deny">Deny Access</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveRoleMappingConfig()">
                    <i class="bi bi-check-lg"></i> Save Mapping
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auth Setup Guide Modal -->
<div class="modal fade" id="authSetupGuideModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-book"></i> Authentication Setup Guide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <h5>Setting up Microsoft Entra ID (Azure AD) SSO</h5>

                <div class="accordion" id="setupGuideAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1">
                                Step 1: Create Enterprise Application
                            </button>
                        </h2>
                        <div id="step1" class="accordion-collapse collapse show" data-bs-parent="#setupGuideAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>Sign in to the <a href="https://portal.azure.com" target="_blank">Azure Portal</a></li>
                                    <li>Navigate to <strong>Microsoft Entra ID</strong> (Azure Active Directory)</li>
                                    <li>Go to <strong>Enterprise Applications</strong>  <strong>+ New application</strong></li>
                                    <li>Click <strong>+ Create your own application</strong></li>
                                    <li>Name it "Lab Document Intelligence" or similar</li>
                                    <li>Select <strong>"Integrate any other application you don't find in the gallery (Non-gallery)"</strong></li>
                                    <li>Click <strong>Create</strong></li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2">
                                Step 2: Configure Single Sign-On
                            </button>
                        </h2>
                        <div id="step2" class="accordion-collapse collapse" data-bs-parent="#setupGuideAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>In your Enterprise Application, go to <strong>Single sign-on</strong></li>
                                    <li>Select <strong>SAML</strong></li>
                                    <li>In <strong>Basic SAML Configuration</strong>, enter:
                                        <ul>
                                            <li><strong>Identifier (Entity ID)</strong>: Copy from the SSO Configuration panel</li>
                                            <li><strong>Reply URL (ACS URL)</strong>: Copy from the SSO Configuration panel</li>
                                        </ul>
                                    </li>
                                    <li>Download the <strong>Federation Metadata XML</strong> URL</li>
                                    <li>Configure claims as needed (email, name, groups)</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3">
                                Step 3: Configure SCIM Provisioning
                            </button>
                        </h2>
                        <div id="step3" class="accordion-collapse collapse" data-bs-parent="#setupGuideAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>In your Enterprise Application, go to <strong>Provisioning</strong></li>
                                    <li>Click <strong>Get started</strong></li>
                                    <li>Set <strong>Provisioning Mode</strong> to <strong>Automatic</strong></li>
                                    <li>Under <strong>Admin Credentials</strong>:
                                        <ul>
                                            <li><strong>Tenant URL</strong>: Copy from the SCIM Configuration panel</li>
                                            <li><strong>Secret Token</strong>: Copy from the SCIM Configuration panel</li>
                                        </ul>
                                    </li>
                                    <li>Click <strong>Test Connection</strong> to verify</li>
                                    <li>Save and configure <strong>Mappings</strong> for users</li>
                                    <li>Turn <strong>Provisioning Status</strong> to <strong>On</strong></li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step4">
                                Step 4: Assign Users and Groups
                            </button>
                        </h2>
                        <div id="step4" class="accordion-collapse collapse" data-bs-parent="#setupGuideAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>In your Enterprise Application, go to <strong>Users and groups</strong></li>
                                    <li>Click <strong>+ Add user/group</strong></li>
                                    <li>Add the security groups you configured in Role Mapping</li>
                                    <li>Or add individual users as needed</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Integration Modal -->
<div class="modal fade" id="addIntegrationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Integration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addIntegrationForm">
                    <div class="mb-3">
                        <label class="form-label">Integration Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newIntegrationName" required placeholder="e.g., Lab System Webhook">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="newIntegrationDesc" placeholder="Brief description...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Integration Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="newIntegrationType" required>
                            <option value="">Select type...</option>
                        </select>
                    </div>
                    <div id="integrationTypeInfo" class="alert alert-light" style="display: none;">
                        <small id="integrationTypeDesc"></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createIntegration()">
                    <i class="bi bi-plus-circle"></i> Create Integration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createApiKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create API Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createApiKeyForm">
                    <div class="mb-3">
                        <label class="form-label">Key Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newApiKeyName" required placeholder="e.g., Logic App - Email Integration">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control" id="newApiKeyDesc" placeholder="What will this key be used for?">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Associate with Integration</label>
                        <select class="form-select" id="newApiKeyIntegration">
                            <option value="">None (General purpose key)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scopeDocsCreate" checked>
                            <label class="form-check-label" for="scopeDocsCreate">Create Documents</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scopeDocsRead">
                            <label class="form-check-label" for="scopeDocsRead">Read Documents</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scopeWebhook" checked>
                            <label class="form-check-label" for="scopeWebhook">Receive Webhooks</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createApiKey()">
                    <i class="bi bi-key"></i> Create Key
                </button>
            </div>
        </div>
    </div>
</div>

<!-- API Key Created Modal (shows the key once) -->
<div class="modal fade" id="apiKeyCreatedModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="bi bi-check-circle"></i> API Key Created</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Important:</strong> Copy this key now. You will not be able to see it again!
                </div>
                <div class="mb-3">
                    <label class="form-label">Your API Key:</label>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace" id="createdApiKey" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyApiKey()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                </div>
                <p class="small text-muted">Use this key in the Authorization header: <code>Authorization: Bearer &lt;key&gt;</code></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I've Copied the Key</button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" required>
                            <option value="reviewer">Reviewer</option>
                            <option value="read_only">Read-Only Auditor</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Species Modal -->
<div class="modal fade" id="speciesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="speciesModalTitle">Add Species</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="speciesForm">
                    <input type="hidden" id="speciesId">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="speciesName" required placeholder="e.g., Dog, Cat, Horse">
                        <small class="text-muted">Scientific or common name used for identification</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Common Name</label>
                        <input type="text" class="form-control" id="speciesCommonName" placeholder="e.g., Canine, Feline, Equine">
                        <small class="text-muted">Alternative or display name</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="speciesCategory" required>
                            <option value="human">Human</option>
                            <option value="veterinary">Veterinary</option>
                        </select>
                        <small class="text-muted">Determines which test menu is shown</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="speciesDescription" rows="2" placeholder="Optional description..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="speciesActive" checked>
                            <label class="form-check-label" for="speciesActive">Active</label>
                        </div>
                        <small class="text-muted">Inactive species won't appear in patient entry</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSpecies()">
                    <i class="bi bi-check-lg"></i> Save Species
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Test Modal -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testModalTitle">Add Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testForm">
                    <input type="hidden" id="testId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Test Code <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCode" required placeholder="e.g., 316">
                                <small class="text-muted">3-digit MiraVista test code</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Test Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testName" required placeholder="e.g., Blastomyces EIA">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Test Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="testType" required>
                            <option value="Antigen Test">Antigen Test</option>
                            <option value="Antibody Test">Antibody Test</option>
                            <option value="Panel - General">Panel - General</option>
                            <option value="Panel - Geographic">Panel - Geographic</option>
                            <option value="Bioassay">Bioassay</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Species <span class="text-danger">*</span></label>
                        <select class="form-select" id="testSpecies" required>
                            <option value="Any">Any</option>
                            <option value="Human">Human</option>
                            <option value="K9">K9 (Canine)</option>
                            <option value="Feline">Feline</option>
                            <option value="Equine">Equine</option>
                            <option value="K9 & Feline">K9 & Feline</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Eligible Specimen Types <span class="text-danger">*</span></label>
                        <div class="border rounded p-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="UR" id="specimen_UR">
                                <label class="form-check-label" for="specimen_UR">UR (Urine)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="SER" id="specimen_SER">
                                <label class="form-check-label" for="specimen_SER">SER (Serum)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="PLS" id="specimen_PLS">
                                <label class="form-check-label" for="specimen_PLS">PLS (Plasma)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="CSF" id="specimen_CSF">
                                <label class="form-check-label" for="specimen_CSF">CSF</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="BAL" id="specimen_BAL">
                                <label class="form-check-label" for="specimen_BAL">BAL</label>
                            </div>
                        </div>
                        <small class="text-muted">Select all specimen types that are eligible for this test</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Sample Volume (mL)</label>
                        <input type="number" class="form-control" id="minSample" step="0.1" min="0" placeholder="e.g., 1.0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="testNotes" rows="3" placeholder="Special handling instructions, test notes, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTest()">Save Test</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let testsData = [];
    let filteredTestsData = [];
    let speciesData = [];
    let currentSortField = 'test_number';
    let currentSortDir = 'asc';

    // Load Reference Data when tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Load users on page load (Users tab is default)
        loadUsers();
        loadScimStatus();

        // Reference Data tab (Species + Test Catalog)
        const referenceDataTab = document.querySelector('button[data-bs-target="#reference-data"]');
        if (referenceDataTab) {
            referenceDataTab.addEventListener('shown.bs.tab', function() {
                loadSpecies();
                loadTests();
            });
        }

        // Load equipment when Equipment tab is shown
        const equipmentTab = document.querySelector('button[data-bs-target="#equipment"]');
        if (equipmentTab) {
            equipmentTab.addEventListener('shown.bs.tab', function() {
                loadScanningStations();
                loadLabelPrinters();
            });
        }

        // Filter event listeners
        document.getElementById('filterTestCode')?.addEventListener('input', applyTestFilters);
        document.getElementById('filterTestName')?.addEventListener('input', applyTestFilters);
        document.getElementById('filterTestType')?.addEventListener('change', applyTestFilters);
        document.getElementById('filterSpecies')?.addEventListener('change', applyTestFilters);
        document.getElementById('filterSpecimen')?.addEventListener('change', applyTestFilters);
    });

    // ============================================
    // User Management Functions
    // ============================================

    async function loadUsers() {
        try {
            const response = await fetch('/api/auth/users', { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load users');

            const data = await response.json();
            const tableBody = document.getElementById('usersTable');

            if (!data.users || data.users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
                return;
            }

            tableBody.innerHTML = data.users.map(user => {
                const roleBadge = {
                    'admin': '<span class="badge bg-danger">Admin</span>',
                    'reviewer': '<span class="badge bg-primary">Reviewer</span>',
                    'read_only': '<span class="badge bg-secondary">Read Only</span>'
                }[user.role] || '<span class="badge bg-secondary">' + user.role + '</span>';

                const statusBadge = user.is_active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-danger">Inactive</span>';

                const authBadge = user.auth_provider === 'entra_id'
                    ? '<span class="badge bg-info"><i class="bi bi-microsoft"></i> Entra ID</span>'
                    : '<span class="badge bg-secondary"><i class="bi bi-person"></i> Local</span>';

                const lastLogin = user.last_login
                    ? formatLocalDate(user.last_login)
                    : '<span class="text-muted">Never</span>';

                const lastSynced = user.last_synced_at
                    ? formatLocalDate(user.last_synced_at)
                    : '<span class="text-muted">-</span>';

                return `
                    <tr>
                        <td>${user.full_name || '<em class="text-muted">No name</em>'}</td>
                        <td>
                            ${user.email}
                            ${user.entra_upn && user.entra_upn !== user.email ? '<br><small class="text-muted">' + user.entra_upn + '</small>' : ''}
                        </td>
                        <td>${authBadge}</td>
                        <td>${roleBadge}</td>
                        <td>${statusBadge}</td>
                        <td><small>${lastLogin}</small></td>
                        <td><small>${lastSynced}</small></td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUserRole('${user.id}', '${user.role}')" title="Change Role">
                                    <i class="bi bi-shield"></i>
                                </button>
                                ${user.is_active
                                    ? `<button class="btn btn-outline-danger" onclick="toggleUserStatus('${user.id}', false)" title="Deactivate">
                                        <i class="bi bi-person-dash"></i>
                                       </button>`
                                    : `<button class="btn btn-outline-success" onclick="toggleUserStatus('${user.id}', true)" title="Activate">
                                        <i class="bi bi-person-check"></i>
                                       </button>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersTable').innerHTML =
                '<tr><td colspan="8" class="text-center text-danger">Error loading users</td></tr>';
        }
    }

    async function loadScimStatus() {
        try {
            const response = await fetch('/api/auth/scim/status', { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load SCIM status');

            const data = await response.json();
            const statusDiv = document.getElementById('scimStatus');

            if (data.scim_configured) {
                statusDiv.innerHTML = `
                    <span class="badge bg-success me-2">SCIM Configured</span>
                    <span class="text-muted">
                        ${data.entra_id_users} Entra ID users, ${data.local_users} local users
                        ${data.last_sync ? ' | Last sync: ' + formatLocalDate(data.last_sync) : ''}
                    </span>
                `;
            } else {
                statusDiv.innerHTML = `
                    <span class="badge bg-warning text-dark me-2">SCIM Not Configured</span>
                    <span class="text-muted">Set SCIM_BEARER_TOKEN environment variable to enable</span>
                `;
            }

            // Update endpoint URL
            const baseUrl = window.location.origin;
            document.getElementById('scimEndpointUrl').textContent = baseUrl + '/scim/v2';

        } catch (error) {
            console.error('Error loading SCIM status:', error);
            document.getElementById('scimStatus').innerHTML =
                '<span class="badge bg-danger">Error checking SCIM status</span>';
        }
    }

    async function testScimEndpoint() {
        alert('To test SCIM:\n\n1. Go to Azure Portal > Entra ID > Enterprise Applications\n2. Select your app > Provisioning\n3. Click "Test Connection"\n\nThe SCIM endpoint is: ' + window.location.origin + '/scim/v2');
    }

    function showScimConfigHelp() {
        const modal = `
            <div class="modal fade" id="scimHelpModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">SCIM Provisioning Setup</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Setup Steps:</h6>
                            <ol>
                                <li>Go to <strong>Azure Portal > Entra ID > Enterprise Applications</strong></li>
                                <li>Select your application (or create a new SCIM app)</li>
                                <li>Go to <strong>Provisioning > Get Started</strong></li>
                                <li>Set <strong>Provisioning Mode</strong> to <code>Automatic</code></li>
                                <li>Set <strong>Tenant URL</strong> to: <code>${window.location.origin}/scim/v2</code></li>
                                <li>Set <strong>Secret Token</strong> to the value of your <code>SCIM_BEARER_TOKEN</code> environment variable</li>
                                <li>Click <strong>Test Connection</strong> - should succeed</li>
                                <li>Configure <strong>Attribute Mappings</strong> (userName, displayName, active, externalId)</li>
                                <li>Set <strong>Provisioning Status</strong> to <code>On</code></li>
                                <li>Assign users/groups to the application to provision them</li>
                            </ol>
                            <hr>
                            <h6>Required Environment Variable:</h6>
                            <code>SCIM_BEARER_TOKEN=your-secret-token-here</code>
                            <p class="text-muted mt-2">Generate a secure random token and set it in both Azure and your app's environment.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        document.getElementById('scimHelpModal')?.remove();
        document.body.insertAdjacentHTML('beforeend', modal);
        new bootstrap.Modal(document.getElementById('scimHelpModal')).show();
    }

    function editUserRole(userId, currentRole) {
        // Create modal HTML with dropdown
        const modalHtml = `
            <div class="modal fade" id="changeRoleModal" tabindex="-1">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="bi bi-shield"></i> Change User Role</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">Select Role</label>
                            <select class="form-select" id="roleSelect">
                                <option value="admin" ${currentRole === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="reviewer" ${currentRole === 'reviewer' ? 'selected' : ''}>Reviewer</option>
                                <option value="read_only" ${currentRole === 'read_only' ? 'selected' : ''}>Read Only</option>
                            </select>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Admin:</strong> Full system access<br>
                                    <strong>Reviewer:</strong> Can review and approve documents<br>
                                    <strong>Read Only:</strong> View-only access
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitRoleChange('${userId}')">
                                <i class="bi bi-check-lg"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        document.getElementById('changeRoleModal')?.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        new bootstrap.Modal(document.getElementById('changeRoleModal')).show();
    }

    async function submitRoleChange(userId) {
        const newRole = document.getElementById('roleSelect').value;

        try {
            const response = await fetch(`/api/auth/users/${userId}/role`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ role: newRole })
            });

            if (!response.ok) throw new Error('Failed to update role');

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('changeRoleModal')).hide();

            // Refresh users list
            await loadUsers();
        } catch (error) {
            alert('Error updating role: ' + error.message);
        }
    }

    async function toggleUserStatus(userId, isActive) {
        const action = isActive ? 'activate' : 'deactivate';
        if (!confirm(`Are you sure you want to ${action} this user?`)) return;

        try {
            const response = await fetch(`/api/auth/users/${userId}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ is_active: isActive })
            });

            if (!response.ok) throw new Error('Failed to update status');
            await loadUsers();
        } catch (error) {
            alert('Error updating status: ' + error.message);
        }
    }

    // Helper function to get auth headers - checks localStorage first, then js_access_token cookie (for SAML SSO)
    function getAuthHeaders() {
        let token = localStorage.getItem('access_token');

        // If no token in localStorage, check for js_access_token cookie (set by SAML SSO)
        if (!token) {
            const cookies = document.cookie.split(';');
            for (const cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'js_access_token' && value) {
                    token = value;
                    // Cache in localStorage for future requests
                    localStorage.setItem('access_token', token);
                    break;
                }
            }
        }

        return {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        };
    }

    // ============================================
    // Species Management Functions
    // ============================================

    async function loadSpecies() {
        try {
            const response = await fetch('/api/config/species?include_inactive=true', {
                headers: getAuthHeaders()
            });
            if (!response.ok) throw new Error('Failed to load species');

            const data = await response.json();
            speciesData = data.species || [];
            renderSpeciesTable();
        } catch (error) {
            console.error('Error loading species:', error);
            document.getElementById('speciesTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error loading species: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function renderSpeciesTable() {
        const tableBody = document.getElementById('speciesTableBody');

        if (!speciesData || speciesData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No species defined. Click "Add Species" to create one.
                    </td>
                </tr>
            `;
            return;
        }

        tableBody.innerHTML = speciesData.map(species => {
            const categoryBadge = species.test_category === 'human'
                ? '<span class="badge bg-primary">Human</span>'
                : '<span class="badge bg-success">Veterinary</span>';

            const statusBadge = species.is_active
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-secondary">Inactive</span>';

            return `
                <tr class="${!species.is_active ? 'table-secondary' : ''}">
                    <td><strong>${species.name}</strong></td>
                    <td>${species.common_name || '<em class="text-muted">-</em>'}</td>
                    <td>${categoryBadge}</td>
                    <td><small>${species.description || '<em class="text-muted">No description</em>'}</small></td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editSpecies(${species.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSpecies(${species.id}, '${species.name}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function showAddSpeciesModal() {
        document.getElementById('speciesModalTitle').textContent = 'Add Species';
        document.getElementById('speciesId').value = '';
        document.getElementById('speciesName').value = '';
        document.getElementById('speciesCommonName').value = '';
        document.getElementById('speciesCategory').value = 'veterinary';
        document.getElementById('speciesDescription').value = '';
        document.getElementById('speciesActive').checked = true;

        const modal = new bootstrap.Modal(document.getElementById('speciesModal'));
        modal.show();
    }

    function editSpecies(speciesId) {
        const species = speciesData.find(s => s.id === speciesId);
        if (!species) {
            alert('Species not found');
            return;
        }

        document.getElementById('speciesModalTitle').textContent = 'Edit Species';
        document.getElementById('speciesId').value = species.id;
        document.getElementById('speciesName').value = species.name;
        document.getElementById('speciesCommonName').value = species.common_name || '';
        document.getElementById('speciesCategory').value = species.test_category;
        document.getElementById('speciesDescription').value = species.description || '';
        document.getElementById('speciesActive').checked = species.is_active;

        const modal = new bootstrap.Modal(document.getElementById('speciesModal'));
        modal.show();
    }

    async function saveSpecies() {
        const speciesId = document.getElementById('speciesId').value;
        const data = {
            name: document.getElementById('speciesName').value,
            common_name: document.getElementById('speciesCommonName').value || null,
            test_category: document.getElementById('speciesCategory').value,
            description: document.getElementById('speciesDescription').value || null,
            is_active: document.getElementById('speciesActive').checked
        };

        if (!data.name) {
            alert('Species name is required');
            return;
        }

        try {
            const url = speciesId ? `/api/config/species/${speciesId}` : '/api/config/species';
            const method = speciesId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save species');
            }

            bootstrap.Modal.getInstance(document.getElementById('speciesModal')).hide();
            await loadSpecies();

        } catch (error) {
            alert('Error saving species: ' + error.message);
        }
    }

    async function deleteSpecies(speciesId, speciesName) {
        if (!confirm(`Are you sure you want to delete "${speciesName}"?\n\nIf this species is in use by patients, it will be deactivated instead of deleted.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/config/species/${speciesId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to delete species');
            }

            const result = await response.json();
            alert(result.message);
            await loadSpecies();

        } catch (error) {
            alert('Error deleting species: ' + error.message);
        }
    }

    // ============================================
    // Test Catalog Functions
    // ============================================

    async function loadTests() {
        try {
            const response = await fetch('/api/tests', {
                headers: getAuthHeaders()
            });
            if (!response.ok) throw new Error('Failed to load tests');

            testsData = await response.json();
            filteredTestsData = [...testsData];

            // Populate filter dropdowns
            populateTestFilterDropdowns();

            // Apply initial sort
            sortTestsBy(currentSortField, false);
        } catch (error) {
            console.error('Error loading tests:', error);
            document.getElementById('testsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error loading tests: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function populateTestFilterDropdowns() {
        // Get unique values for each filter
        const testTypes = [...new Set(testsData.map(t => t.test_type).filter(Boolean))].sort();
        const species = [...new Set(testsData.map(t => t.species || 'Any').filter(Boolean))].sort();
        const specimens = [...new Set(testsData.flatMap(t => t.eligible_specimens || []))].sort();

        // Populate Test Type dropdown
        const typeSelect = document.getElementById('filterTestType');
        typeSelect.innerHTML = '<option value="">All Types</option>' +
            testTypes.map(t => `<option value="${t}">${t}</option>`).join('');

        // Populate Species dropdown
        const speciesSelect = document.getElementById('filterSpecies');
        speciesSelect.innerHTML = '<option value="">All Species</option>' +
            species.map(s => `<option value="${s}">${s}</option>`).join('');

        // Populate Specimen dropdown
        const specimenSelect = document.getElementById('filterSpecimen');
        specimenSelect.innerHTML = '<option value="">All Specimens</option>' +
            specimens.map(s => `<option value="${s}">${s}</option>`).join('');
    }

    function applyTestFilters() {
        const codeFilter = document.getElementById('filterTestCode')?.value.toLowerCase() || '';
        const nameFilter = document.getElementById('filterTestName')?.value.toLowerCase() || '';
        const typeFilter = document.getElementById('filterTestType')?.value || '';
        const speciesFilter = document.getElementById('filterSpecies')?.value || '';
        const specimenFilter = document.getElementById('filterSpecimen')?.value || '';

        filteredTestsData = testsData.filter(test => {
            const matchCode = !codeFilter || test.test_number.toLowerCase().includes(codeFilter);
            const matchName = !nameFilter || test.test_name.toLowerCase().includes(nameFilter);
            const matchType = !typeFilter || test.test_type === typeFilter;
            const matchSpecies = !speciesFilter || (test.species || 'Any') === speciesFilter;
            const matchSpecimen = !specimenFilter || (test.eligible_specimens || []).includes(specimenFilter);

            return matchCode && matchName && matchType && matchSpecies && matchSpecimen;
        });

        // Re-apply current sort
        sortTestsBy(currentSortField, false);
    }

    function clearTestFilters() {
        document.getElementById('filterTestCode').value = '';
        document.getElementById('filterTestName').value = '';
        document.getElementById('filterTestType').value = '';
        document.getElementById('filterSpecies').value = '';
        document.getElementById('filterSpecimen').value = '';
        filteredTestsData = [...testsData];
        sortTestsBy(currentSortField, false);
    }

    function sortTestsBy(field, toggleDir = true) {
        // Toggle direction if clicking the same field
        if (toggleDir && field === currentSortField) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
        } else if (toggleDir) {
            currentSortDir = 'asc';
        }
        currentSortField = field;

        // Update sort icons
        document.querySelectorAll('[id^="sort-"]').forEach(icon => {
            icon.className = 'bi bi-arrow-down-up';
        });
        const currentIcon = document.getElementById(`sort-${field}`);
        if (currentIcon) {
            currentIcon.className = currentSortDir === 'asc' ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        }

        // Sort the data
        filteredTestsData.sort((a, b) => {
            let valA = a[field];
            let valB = b[field];

            // Handle numeric fields
            if (field === 'test_number' || field === 'minimum_sample_ml') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            } else {
                valA = (valA || '').toString().toLowerCase();
                valB = (valB || '').toString().toLowerCase();
            }

            if (valA < valB) return currentSortDir === 'asc' ? -1 : 1;
            if (valA > valB) return currentSortDir === 'asc' ? 1 : -1;
            return 0;
        });

        renderTests(filteredTestsData);
    }

    function renderTests(tests) {
        const tbody = document.getElementById('testsTableBody');
        if (!tests || tests.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="bi bi-inbox"></i> No tests found. Click "Add Test" to create one.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = tests.map(test => `
            <tr>
                <td><strong>${test.test_number}</strong></td>
                <td>${test.test_name}</td>
                <td><span class="badge bg-info">${test.test_type}</span></td>
                <td><span class="badge bg-secondary">${test.species || 'Any'}</span></td>
                <td>${test.eligible_specimens.join(', ')}</td>
                <td>${test.minimum_sample_ml || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTest(${test.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTest(${test.id}, '${test.test_number}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function showAddTestModal() {
        document.getElementById('testModalTitle').textContent = 'Add Test';
        document.getElementById('testForm').reset();
        document.getElementById('testId').value = '';
        document.getElementById('testCode').readOnly = false;

        const modal = new bootstrap.Modal(document.getElementById('testModal'));
        modal.show();
    }

    async function editTest(testId) {
        try {
            const response = await fetch(`/api/tests/${testId}`, {
                headers: getAuthHeaders()
            });
            if (!response.ok) throw new Error('Failed to load test');

            const test = await response.json();

            document.getElementById('testModalTitle').textContent = 'Edit Test';
            document.getElementById('testId').value = test.id;
            document.getElementById('testCode').value = test.test_number;
            document.getElementById('testCode').readOnly = true;
            document.getElementById('testName').value = test.test_name;
            document.getElementById('testType').value = test.test_type;
            document.getElementById('testSpecies').value = test.species || 'Any';
            document.getElementById('minSample').value = test.minimum_sample_ml || '';
            document.getElementById('testNotes').value = test.notes || '';

            // Set specimen checkboxes
            document.querySelectorAll('[id^="specimen_"]').forEach(cb => cb.checked = false);
            test.eligible_specimens.forEach(specimen => {
                const checkbox = document.getElementById(`specimen_${specimen}`);
                if (checkbox) checkbox.checked = true;
            });

            const modal = new bootstrap.Modal(document.getElementById('testModal'));
            modal.show();
        } catch (error) {
            alert('Error loading test: ' + error.message);
        }
    }

    async function saveTest() {
        const form = document.getElementById('testForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const testId = document.getElementById('testId').value;
        const eligibleSpecimens = Array.from(document.querySelectorAll('[id^="specimen_"]:checked'))
            .map(cb => cb.value);

        if (eligibleSpecimens.length === 0) {
            alert('Please select at least one eligible specimen type');
            return;
        }

        const testData = {
            test_number: document.getElementById('testCode').value.trim(),
            test_name: document.getElementById('testName').value.trim(),
            test_type: document.getElementById('testType').value,
            species: document.getElementById('testSpecies').value,
            eligible_specimens: eligibleSpecimens,
            minimum_sample_ml: parseFloat(document.getElementById('minSample').value) || null,
            notes: document.getElementById('testNotes').value.trim() || null
        };

        try {
            const url = testId ? `/api/tests/${testId}` : '/api/tests';
            const method = testId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(testData)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save test');
            }

            // Close modal and reload tests
            bootstrap.Modal.getInstance(document.getElementById('testModal')).hide();
            await loadTests();

            alert(testId ? 'Test updated successfully!' : 'Test created successfully!');
        } catch (error) {
            alert('Error saving test: ' + error.message);
        }
    }

    async function deleteTest(testId, testCode) {
        if (!confirm(`Are you sure you want to delete test ${testCode}? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/tests/${testId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to delete test');
            }

            await loadTests();
            alert('Test deleted successfully!');
        } catch (error) {
            alert('Error deleting test: ' + error.message);
        }
    }

    // ============================================
    // Background Jobs Management
    // ============================================

    let jobsAutoRefreshInterval = null;

    // Load all background jobs
    async function loadJobs() {
        try {
            const response = await fetch('/api/documents/all-jobs', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to load jobs');
            }

            const jobs = await response.json();
            displayJobs(jobs);
        } catch (error) {
            console.error('Error loading jobs:', error);
            document.getElementById('jobsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        Error loading jobs: ${error.message}
                    </td>
                </tr>
            `;
        }
    }

    function displayJobs(jobs) {
        const tbody = document.getElementById('jobsTableBody');

        if (!jobs || jobs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No background jobs found</td></tr>';
            return;
        }

        tbody.innerHTML = jobs.map(job => {
            const statusBadge = getStatusBadge(job.status);
            const progress = job.total_files > 0
                ? Math.round((job.processed_files / job.total_files) * 100)
                : 0;

            const startedTime = formatDateTime(job.started_at);
            const completedTime = job.completed_at ? formatDateTime(job.completed_at) : '-';

            const canCancel = job.status === 'processing' || job.status === 'queued';
            const canRetry = job.status === 'failed' || job.status === 'cancelled';

            return `
                <tr>
                    <td>
                        <small class="font-monospace">${job.job_id.substring(0, 8)}...</small>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${progress === 100 ? 'bg-success' : 'bg-primary'}"
                                 role="progressbar"
                                 style="width: ${progress}%"
                                 aria-valuenow="${progress}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                ${progress}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <small>
                            ${job.processed_files}/${job.total_files}<br>
                            <span class="text-success">${job.successful_files} </span>
                            <span class="text-danger">${job.failed_files} </span>
                        </small>
                    </td>
                    <td><small>${startedTime}</small></td>
                    <td><small>${completedTime}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-info" onclick="viewJobDetails('${job.job_id}')" title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${canCancel ? `
                                <button class="btn btn-outline-danger" onclick="cancelJob('${job.job_id}')" title="Cancel Job">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            ` : ''}
                            ${canRetry ? `
                                <button class="btn btn-outline-warning" onclick="retryJob('${job.job_id}')" title="Retry Job">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-secondary" onclick="deleteJob('${job.job_id}')" title="Delete Job">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getStatusBadge(status) {
        const badges = {
            'queued': '<span class="badge bg-secondary">Queued</span>',
            'processing': '<span class="badge bg-primary">Processing</span>',
            'completed': '<span class="badge bg-success">Completed</span>',
            'failed': '<span class="badge bg-danger">Failed</span>',
            'cancelled': '<span class="badge bg-warning">Cancelled</span>'
        };
        return badges[status] || `<span class="badge bg-secondary">${status}</span>`;
    }

    async function viewJobDetails(jobId) {
        try {
            const response = await fetch(`/api/documents/upload-status/${jobId}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to load job details');
            }

            const job = await response.json();
            displayJobDetails(job);
        } catch (error) {
            alert('Error loading job details: ' + error.message);
        }
    }

    function displayJobDetails(job) {
        document.getElementById('detailJobId').textContent = job.job_id;
        document.getElementById('detailStatus').innerHTML = getStatusBadge(job.status);
        document.getElementById('detailTotalFiles').textContent = job.total_files || 0;
        document.getElementById('detailProcessed').textContent = job.processed_files || 0;
        document.getElementById('detailSuccessful').textContent = job.successful_files || 0;
        document.getElementById('detailFailed').textContent = job.failed_files || 0;
        document.getElementById('detailStarted').textContent = formatDateTime(job.started_at);
        document.getElementById('detailCompleted').textContent = job.completed_at ? formatDateTime(job.completed_at) : '-';
        document.getElementById('detailError').textContent = job.error || '-';

        // Calculate duration
        if (job.started_at) {
            const start = new Date(job.started_at);
            const end = job.completed_at ? new Date(job.completed_at) : new Date();
            const durationMs = end - start;
            const durationSec = Math.round(durationMs / 1000);
            document.getElementById('detailDuration').textContent = `${durationSec}s`;
        } else {
            document.getElementById('detailDuration').textContent = '-';
        }

        // Display results
        const resultsBody = document.getElementById('jobResultsTableBody');
        if (job.results && job.results.length > 0) {
            resultsBody.innerHTML = job.results.map(result => `
                <tr>
                    <td>${result.filename}</td>
                    <td>${result.status === 'success' ? '<span class="badge bg-success">Success</span>' : '<span class="badge bg-danger">Failed</span>'}</td>
                    <td>${result.accession_number || '-'}</td>
                    <td>${result.confidence_score ? (result.confidence_score * 100).toFixed(1) + '%' : '-'}</td>
                    <td class="text-danger">${result.error || '-'}</td>
                </tr>
            `).join('');
        } else {
            resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No results yet</td></tr>';
        }

        document.getElementById('jobDetailsPanel').style.display = 'block';
    }

    async function cancelJob(jobId) {
        if (!confirm('Are you sure you want to cancel this job? Files already processed will remain.')) {
            return;
        }

        try {
            const response = await fetch(`/api/documents/cancel-job/${jobId}`, {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to cancel job');
            }

            alert('Job cancelled successfully');
            await loadJobs();
        } catch (error) {
            alert('Error cancelling job: ' + error.message);
        }
    }

    async function retryJob(jobId) {
        if (!confirm('Are you sure you want to retry this job?')) {
            return;
        }

        try {
            const response = await fetch(`/api/documents/retry-job/${jobId}`, {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to retry job');
            }

            alert('Job queued for retry');
            await loadJobs();
        } catch (error) {
            alert('Error retrying job: ' + error.message);
        }
    }

    async function deleteJob(jobId) {
        if (!confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/documents/delete-job/${jobId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to delete job');
            }

            alert('Job deleted successfully');
            document.getElementById('jobDetailsPanel').style.display = 'none';
            await loadJobs();
        } catch (error) {
            alert('Error deleting job: ' + error.message);
        }
    }

    function refreshJobs() {
        loadJobs();
    }

    function formatDateTime(dateStr) {
        return formatLocalDate(dateStr);
    }

    // Auto-refresh jobs when on the jobs tab
    document.querySelectorAll('[data-bs-target="#jobs"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function () {
            loadJobs();
            // Auto-refresh every 5 seconds when on jobs tab
            jobsAutoRefreshInterval = setInterval(loadJobs, 5000);
        });
    });

    // Stop auto-refresh when leaving jobs tab
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            if (event.target.getAttribute('data-bs-target') !== '#jobs') {
                if (jobsAutoRefreshInterval) {
                    clearInterval(jobsAutoRefreshInterval);
                    jobsAutoRefreshInterval = null;
                }
            }
        });
    });

    // ============================================
    // Processing Queue Functions
    // ============================================

    let queueAutoRefreshInterval = null;

    // Load queue when tab is shown
    document.querySelector('button[data-bs-target="#queue"]')?.addEventListener('shown.bs.tab', function() {
        refreshQueueStatus();
        // Auto-refresh every 5 seconds
        queueAutoRefreshInterval = setInterval(refreshQueueStatus, 5000);
    });

    // Stop auto-refresh when leaving queue tab
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            if (event.target.getAttribute('data-bs-target') !== '#queue') {
                if (queueAutoRefreshInterval) {
                    clearInterval(queueAutoRefreshInterval);
                    queueAutoRefreshInterval = null;
                }
            }
        });
    });

    async function refreshQueueStatus() {
        try {
            // Get queue status
            const statusResponse = await fetch('/api/config/queue/status', {
                headers: getAuthHeaders()
            });
            if (statusResponse.ok) {
                const status = await statusResponse.json();
                document.getElementById('queuedCount').textContent = status.queued_count;
                document.getElementById('processingCount').textContent = status.processing_count;
                document.getElementById('extractedCount').textContent = status.extracted_count;
                document.getElementById('failedCount').textContent = status.failed_count;
            }

            // Get worker status
            const workerResponse = await fetch('/api/config/worker/status', {
                headers: getAuthHeaders()
            });
            if (workerResponse.ok) {
                const worker = await workerResponse.json();
                const statusSpan = document.getElementById('workerStatus');
                const alert = document.getElementById('workerStatusAlert');
                const startBtn = document.getElementById('startWorkerBtn');
                const stopBtn = document.getElementById('stopWorkerBtn');
                if (worker.running) {
                    statusSpan.textContent = 'Running';
                    alert.className = 'alert alert-success';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                } else {
                    statusSpan.textContent = worker.status === 'not_started' ? 'Not Started' : 'Stopped';
                    alert.className = 'alert alert-warning';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                }
            }

            // Get blob watcher status
            const blobWatcherResponse = await fetch('/api/config/blob-watcher/status', {
                headers: getAuthHeaders()
            });
            if (blobWatcherResponse.ok) {
                const blobWatcher = await blobWatcherResponse.json();
                const statusSpan = document.getElementById('blobWatcherStatus');
                const detailsSpan = document.getElementById('blobWatcherDetails');
                const alert = document.getElementById('blobWatcherStatusAlert');
                const startBtn = document.getElementById('startBlobWatcherBtn');
                const stopBtn = document.getElementById('stopBlobWatcherBtn');

                if (blobWatcher.running) {
                    statusSpan.textContent = 'Running';
                    alert.className = 'alert alert-success';
                    detailsSpan.textContent = '(' + blobWatcher.known_blobs + ' tracked blobs)';
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                } else {
                    statusSpan.textContent = blobWatcher.status === 'not_started' ? 'Not Started' : 'Stopped';
                    alert.className = 'alert alert-warning';
                    detailsSpan.textContent = '';
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                }
            }

            // Get queue documents
            const docsResponse = await fetch('/api/config/queue/documents?limit=20', {
                headers: getAuthHeaders()
            });
            if (docsResponse.ok) {
                const data = await docsResponse.json();
                renderQueueDocuments(data.documents);
            }

            // Get batches
            const batchesResponse = await fetch('/api/config/queue/batches?limit=10', {
                headers: getAuthHeaders()
            });
            if (batchesResponse.ok) {
                const data = await batchesResponse.json();
                renderBatches(data.batches);
            }

        } catch (error) {
            console.error('Error loading queue status:', error);
        }
    }

    function renderQueueDocuments(documents) {
        const tbody = document.getElementById('queueDocumentsTable');
        if (!documents || documents.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No documents in queue</td></tr>';
            return;
        }

        tbody.innerHTML = documents.map(doc => {
            const statusBadge = {
                'queued': 'warning',
                'processing': 'primary',
                'extracted': 'success',
                'failed': 'danger'
            }[doc.processing_status] || 'secondary';

            return `
                <tr>
                    <td>${doc.accession_number}</td>
                    <td>${doc.filename}</td>
                    <td><span class="badge bg-${statusBadge}">${doc.processing_status}</span></td>
                    <td>${doc.batch_id ? doc.batch_id.substring(0, 8) + '...' : '-'}</td>
                    <td>${doc.extraction_attempts}</td>
                    <td>${formatLocalDate(doc.queued_at)}</td>
                    <td>${doc.last_error ? '<span class="text-danger" title="' + doc.last_error + '">' + doc.last_error.substring(0, 30) + '...</span>' : '-'}</td>
                    <td>
                        ${doc.processing_status === 'failed' ?
                            `<button class="btn btn-sm btn-outline-warning" onclick="requeueDocument(${doc.id})">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function renderBatches(batches) {
        const tbody = document.getElementById('batchesTable');
        if (!batches || batches.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No batches yet</td></tr>';
            return;
        }

        tbody.innerHTML = batches.map(batch => {
            const statusBadge = {
                'queued': 'warning',
                'processing': 'primary',
                'completed': 'success',
                'failed': 'danger',
                'split': 'info'
            }[batch.status] || 'secondary';

            return `
                <tr>
                    <td title="${batch.id}">${batch.id.substring(0, 8)}...</td>
                    <td><span class="badge bg-${statusBadge}">${batch.status}</span></td>
                    <td>${batch.document_count}</td>
                    <td><span class="text-success">${batch.successful_count}</span> / <span class="text-danger">${batch.failed_count}</span></td>
                    <td>${batch.attempt_number}</td>
                    <td>${formatLocalDate(batch.created_at)}</td>
                    <td>${formatLocalDate(batch.completed_at)}</td>
                </tr>
            `;
        }).join('');
    }

    async function requeueDocument(documentId) {
        try {
            const response = await fetch(`/api/config/queue/requeue/${documentId}`, {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to requeue document');
            }

            alert('Document requeued successfully');
            refreshQueueStatus();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function requeueAllFailed() {
        if (!confirm('Are you sure you want to requeue all failed documents?')) {
            return;
        }

        try {
            const response = await fetch('/api/config/queue/requeue-all-failed', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to requeue documents');
            }

            const result = await response.json();
            alert(`${result.requeued_count} documents requeued successfully`);
            refreshQueueStatus();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    async function triggerBlobScan() {
        try {
            const btn = event.target.closest('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning...';

            const response = await fetch('/api/config/blob-watcher/scan', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Scan failed');
            }

            const result = await response.json();
            alert('Blob scan completed. ' + result.known_blobs + ' blobs tracked.');
            refreshQueueStatus();
        } catch (error) {
            alert('Error: ' + error.message);
        } finally {
            const btn = document.querySelector('#blobWatcherStatusAlert .btn-outline-primary');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search"></i> Scan Now';
            }
        }
    }

    // Extraction Worker Controls
    async function startExtractionWorker() {
        try {
            const btn = document.getElementById('startWorkerBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';

            const response = await fetch('/api/queue/extraction-worker/start', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to start worker');
            }

            refreshQueueStatus();
        } catch (error) {
            alert('Error starting worker: ' + error.message);
        } finally {
            const btn = document.getElementById('startWorkerBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Start';
        }
    }

    async function stopExtractionWorker() {
        if (!confirm('Stop the extraction worker? Documents currently processing may fail.')) {
            return;
        }

        try {
            const btn = document.getElementById('stopWorkerBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Stopping...';

            const response = await fetch('/api/queue/extraction-worker/stop', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to stop worker');
            }

            refreshQueueStatus();
        } catch (error) {
            alert('Error stopping worker: ' + error.message);
        } finally {
            const btn = document.getElementById('stopWorkerBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stop-fill"></i> Stop';
        }
    }

    async function triggerProcessCycle() {
        try {
            const response = await fetch('/api/queue/extraction-worker/process', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to trigger processing');
            }

            alert('Processing cycle triggered. Check queue status for updates.');
            refreshQueueStatus();
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Blob Watcher Controls
    async function startBlobWatcher() {
        try {
            const btn = document.getElementById('startBlobWatcherBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Starting...';

            const response = await fetch('/api/queue/blob-watcher/start', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to start blob watcher');
            }

            refreshQueueStatus();
        } catch (error) {
            alert('Error starting blob watcher: ' + error.message);
        } finally {
            const btn = document.getElementById('startBlobWatcherBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Start';
        }
    }

    async function stopBlobWatcher() {
        if (!confirm('Stop the blob watcher? New files will not be detected until restarted.')) {
            return;
        }

        try {
            const btn = document.getElementById('stopBlobWatcherBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Stopping...';

            const response = await fetch('/api/queue/blob-watcher/stop', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to stop blob watcher');
            }

            refreshQueueStatus();
        } catch (error) {
            alert('Error stopping blob watcher: ' + error.message);
        } finally {
            const btn = document.getElementById('stopBlobWatcherBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stop-fill"></i> Stop';
        }
    }

    // ============================================
    // Configuration Functions
    // ============================================

    // Load configs when tab is shown
    document.querySelector('button[data-bs-target="#config"]')?.addEventListener('shown.bs.tab', function() {
        loadConfigs();
        loadEnvSettings();
    });

    // Load environment settings from Azure
    async function loadEnvSettings() {
        try {
            const response = await fetch('/api/config/env/settings', {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to load environment settings');

            const data = await response.json();

            // Populate category filter
            const categorySelect = document.getElementById('envCategoryFilter');
            if (categorySelect && data.categories) {
                const currentValue = categorySelect.value;
                categorySelect.innerHTML = '<option value="">All Categories</option>' +
                    data.categories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1).replace(/_/g, ' ')}</option>`).join('');
                categorySelect.value = currentValue;
            }

            // Filter by category if selected
            const selectedCategory = categorySelect?.value || '';
            const filteredSettings = selectedCategory
                ? data.settings.filter(s => s.category === selectedCategory)
                : data.settings;

            // Render environment settings
            renderEnvSettings(filteredSettings);

        } catch (error) {
            console.error('Error loading environment settings:', error);
            document.getElementById('envSettingsTable').innerHTML = `
                <tr><td colspan="5" class="text-center text-danger">Error loading environment settings: ${error.message}</td></tr>
            `;
        }
    }

    function renderEnvSettings(settings) {
        const tbody = document.getElementById('envSettingsTable');
        if (!settings || settings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No environment settings found</td></tr>';
            return;
        }

        tbody.innerHTML = settings.map(setting => {
            // Create editable input based on value type
            let inputHtml;
            if (setting.value_type === 'bool') {
                inputHtml = `
                    <select class="form-select form-select-sm" id="env_${setting.key}" data-original="${setting.value}">
                        <option value="true" ${setting.value === 'true' ? 'selected' : ''}>true</option>
                        <option value="false" ${setting.value === 'false' ? 'selected' : ''}>false</option>
                    </select>`;
            } else if (setting.value_type === 'select' && setting.options) {
                const optionsHtml = setting.options.map(opt => 
                    `<option value="${opt}" ${setting.value === opt ? 'selected' : ''}>${opt}</option>`
                ).join('');
                inputHtml = `<select class="form-select form-select-sm" id="env_${setting.key}" data-original="${setting.value}">${optionsHtml}</select>`;
            } else {
                inputHtml = `<input type="text" class="form-control form-control-sm" id="env_${setting.key}" 
                                   value="${setting.value || ''}" data-original="${setting.value || ''}" 
                                   style="min-width: 200px;">`;
            }

            return `
            <tr>
                <td><strong>${setting.key}</strong></td>
                <td>${inputHtml}</td>
                <td><small class="text-muted">${setting.description || '-'}</small></td>
                <td><span class="badge bg-secondary">${setting.category}</span></td>
                <td>
                    ${setting.requires_restart
                        ? '<span class="badge bg-warning text-dark"><i class="bi bi-arrow-repeat"></i> Yes</span>'
                        : '<span class="badge bg-light text-dark">No</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="saveEnvSetting('${setting.key}')">
                        <i class="bi bi-check"></i> Save
                    </button>
                </td>
            </tr>
        `}).join('');
    }

    async function saveEnvSetting(key) {
        const input = document.getElementById('env_' + key);
        const newValue = input.value;
        const originalValue = input.dataset.original;

        if (newValue === originalValue) {
            return; // No change
        }

        try {
            const response = await fetch('/api/config/env/settings/' + key, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ value: newValue })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save setting');
            }

            const result = await response.json();
            input.dataset.original = newValue;
            input.classList.add('is-valid');
            setTimeout(function() { input.classList.remove('is-valid'); }, 2000);

            // Show restart notice if needed
            if (result.requires_restart) {
                const restartNow = confirm(
                    'Setting "' + key + '" saved successfully. ' +
                    'This setting requires an app restart to take effect. Restart now?'
                );
                if (restartNow) {
                    await restartApp();
                }
            } else {
                alert('Setting "' + key + '" saved successfully.');
            }

        } catch (error) {
            alert('Error saving setting: ' + error.message);
            input.value = originalValue;
        }
    }

    async function restartApp() {
        try {
            const response = await fetch('/api/config/env/restart', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to restart app');
            }

            alert('App restart initiated. The page will reload in a few seconds.');
            setTimeout(function() { window.location.reload(); }, 5000);

        } catch (error) {
            alert('Error restarting app: ' + error.message);
        }
    }

    async function loadConfigs() {
        try {
            const category = document.getElementById('configCategoryFilter')?.value || '';
            const url = category ? `/api/config/?category=${category}` : '/api/config/';

            const response = await fetch(url, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to load configs');

            const data = await response.json();

            // Populate category filter
            const categorySelect = document.getElementById('configCategoryFilter');
            if (categorySelect && data.categories) {
                const currentValue = categorySelect.value;
                categorySelect.innerHTML = '<option value="">All Categories</option>' +
                    data.categories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
                categorySelect.value = currentValue;
            }

            // Render configs
            renderConfigs(data.configs);

        } catch (error) {
            console.error('Error loading configs:', error);
            document.getElementById('configTable').innerHTML = `
                <tr><td colspan="6" class="text-center text-danger">Error loading configuration: ${error.message}</td></tr>
            `;
        }
    }

    function renderConfigs(configs) {
        const accordion = document.getElementById('configAccordion');
        if (!configs || configs.length === 0) {
            accordion.innerHTML = '<div class="text-center text-muted py-4">No configuration settings found</div>';
            return;
        }

        // Group configs by category
        const grouped = {};
        configs.forEach(config => {
            const category = config.category || 'general';
            if (!grouped[category]) {
                grouped[category] = [];
            }
            grouped[category].push(config);
        });

        // Sort categories alphabetically
        const sortedCategories = Object.keys(grouped).sort();

        // Category display names and icons
        const categoryInfo = {
            'extraction': { name: 'Extraction Settings', icon: 'bi-cpu' },
            'security': { name: 'Security Settings', icon: 'bi-shield-lock' },
            'documents': { name: 'Document Settings', icon: 'bi-file-earmark-text' },
            'compliance': { name: 'Compliance & Audit', icon: 'bi-clipboard-check' },
            'storage': { name: 'Storage Settings', icon: 'bi-cloud-upload' },
            'blob_watcher': { name: 'Blob Watcher', icon: 'bi-eye' },
            'azure_openai': { name: 'Azure OpenAI', icon: 'bi-robot' },
            'integration': { name: 'Integrations', icon: 'bi-plug' },
            'storage_lifecycle': { name: 'Storage Lifecycle', icon: 'bi-archive' },
            'scanner': { name: 'Scanner Settings', icon: 'bi-printer' },
            'general': { name: 'General', icon: 'bi-gear' }
        };

        // Build accordion HTML
        let html = '';
        sortedCategories.forEach((category, index) => {
            const info = categoryInfo[category] || { name: category.charAt(0).toUpperCase() + category.slice(1).replace(/_/g, ' '), icon: 'bi-gear' };
            const categoryConfigs = grouped[category];
            const isFirst = index === 0;

            let tableRows = '';
            categoryConfigs.forEach(config => {
                const escapedValue = String(config.value).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                tableRows += `
                    <tr>
                        <td><code>${config.key}</code></td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   id="config_${config.key}"
                                   value="${escapedValue}"
                                   data-original="${escapedValue}"
                                   style="min-width: 80px;">
                        </td>
                        <td><small class="text-muted">${config.description || '-'}</small></td>
                        <td>
                            <span class="badge ${config.source === 'database' ? 'bg-success' : 'bg-info'}">
                                ${config.source}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="saveConfig('${config.key}')">
                                <i class="bi bi-check"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading_${category}">
                        <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapse_${category}"
                                aria-expanded="${isFirst}" aria-controls="collapse_${category}">
                            <i class="bi ${info.icon} me-2"></i>
                            <strong>${info.name}</strong>
                            <span class="badge bg-secondary ms-2">${categoryConfigs.length}</span>
                        </button>
                    </h2>
                    <div id="collapse_${category}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}"
                         aria-labelledby="heading_${category}">
                        <div class="accordion-body p-0">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 25%">Setting</th>
                                        <th style="width: 20%">Value</th>
                                        <th style="width: 35%">Description</th>
                                        <th style="width: 10%">Source</th>
                                        <th style="width: 10%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
        });

        accordion.innerHTML = html;
    }

    function expandAllConfigs() {
        document.querySelectorAll('#configAccordion .accordion-collapse').forEach(el => {
            el.classList.add('show');
        });
        document.querySelectorAll('#configAccordion .accordion-button').forEach(el => {
            el.classList.remove('collapsed');
            el.setAttribute('aria-expanded', 'true');
        });
    }

    function collapseAllConfigs() {
        document.querySelectorAll('#configAccordion .accordion-collapse').forEach(el => {
            el.classList.remove('show');
        });
        document.querySelectorAll('#configAccordion .accordion-button').forEach(el => {
            el.classList.add('collapsed');
            el.setAttribute('aria-expanded', 'false');
        });
    }

    async function saveConfig(key) {
        const input = document.getElementById(`config_${key}`);
        const newValue = input.value;
        const originalValue = input.dataset.original;

        if (newValue === originalValue) {
            return; // No change
        }

        try {
            const response = await fetch(`/api/config/${key}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ value: newValue })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save config');
            }

            input.dataset.original = newValue;
            input.classList.add('is-valid');
            setTimeout(() => input.classList.remove('is-valid'), 2000);

        } catch (error) {
            alert('Error saving config: ' + error.message);
            input.value = originalValue;
        }
    }

    async function seedConfigs() {
        if (!confirm('This will add any missing default configuration settings. Continue?')) {
            return;
        }

        try {
            const response = await fetch('/api/config/seed/config', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to seed configs');
            }

            const result = await response.json();
            alert(`Configuration seeded successfully!\nCreated: ${result.configs_created} new settings\nTotal: ${result.total_configs} settings`);
            loadConfigs();

        } catch (error) {
            alert('Error seeding configs: ' + error.message);
        }
    }

    // ============================================
    // Audit Log Functions
    // ============================================

    let currentAuditLogs = []; // Store for export

    // Load audit logs when tab is shown
    document.querySelector('button[data-bs-target="#audit"]')?.addEventListener('shown.bs.tab', function() {
        // Set default date range (last 30 days)
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);

        document.getElementById('auditEndDate').value = endDate.toISOString().split('T')[0];
        document.getElementById('auditStartDate').value = startDate.toISOString().split('T')[0];

        loadAuditLogs();
    });

    async function loadAuditLogs() {
        try {
            // Build query parameters from filters
            const params = new URLSearchParams();

            const startDate = document.getElementById('auditStartDate').value;
            const endDate = document.getElementById('auditEndDate').value;
            const userFilter = document.getElementById('auditUserFilter').value;
            const actionFilter = document.getElementById('auditActionFilter').value;
            const resourceFilter = document.getElementById('auditResourceFilter').value;
            const limit = document.getElementById('auditLimitFilter').value;

            if (startDate) params.append('start_date', startDate + 'T00:00:00');
            if (endDate) params.append('end_date', endDate + 'T23:59:59');
            if (userFilter) params.append('user_id', userFilter);
            if (actionFilter) params.append('action', actionFilter);
            if (resourceFilter) params.append('resource_type', resourceFilter);
            params.append('limit', limit);

            const response = await fetch(`/api/compliance/audit-logs?${params.toString()}`, {
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to load audit logs');

            const data = await response.json();
            const tableBody = document.getElementById('auditLogTable');
            currentAuditLogs = data.logs || [];

            // Update count display
            document.getElementById('auditLogCount').textContent = `Showing ${currentAuditLogs.length} of ${data.total} logs`;

            if (currentAuditLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No audit logs found matching filters</td></tr>';
                return;
            }

            tableBody.innerHTML = currentAuditLogs.map(log => {
                const timestamp = formatLocalDate(log.timestamp);
                const phiAccessed = log.phi_accessed && log.phi_accessed.length > 0;
                const phiBadge = phiAccessed
                    ? '<span class="badge bg-warning text-dark">Yes</span>'
                    : '<span class="badge bg-secondary">No</span>';
                const statusBadge = log.success
                    ? '<span class="badge bg-success">Success</span>'
                    : '<span class="badge bg-danger">Failed</span>';

                return `
                    <tr>
                        <td><small>${timestamp}</small></td>
                        <td>${log.user_email || 'System'}</td>
                        <td><code>${log.action}</code></td>
                        <td>${log.resource || ''}</td>
                        <td>${phiBadge}</td>
                        <td>${statusBadge}</td>
                        <td><small>${log.ip_address || ''}</small></td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('Error loading audit logs:', error);
            document.getElementById('auditLogTable').innerHTML =
                '<tr><td colspan="7" class="text-center text-danger">Error loading audit logs</td></tr>';
            document.getElementById('auditLogCount').textContent = '';
        }
    }

    function clearAuditFilters() {
        document.getElementById('auditStartDate').value = '';
        document.getElementById('auditEndDate').value = '';
        document.getElementById('auditUserFilter').value = '';
        document.getElementById('auditActionFilter').value = '';
        document.getElementById('auditResourceFilter').value = '';
        document.getElementById('auditLimitFilter').value = '100';
        loadAuditLogs();
    }

    function exportAuditLogs() {
        if (!currentAuditLogs || currentAuditLogs.length === 0) {
            alert('No audit logs to export');
            return;
        }

        // Build CSV content
        const headers = ['Timestamp', 'User', 'Action', 'Resource', 'PHI Accessed', 'Success', 'IP Address'];
        const rows = currentAuditLogs.map(log => [
            new Date(log.timestamp).toISOString(),
            log.user_email || '',
            log.action || '',
            log.resource || '',
            (log.phi_accessed && log.phi_accessed.length > 0) ? 'Yes' : 'No',
            log.success ? 'Success' : 'Failed',
            log.ip_address || ''
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
        ].join('\n');

        // Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `audit_logs_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // ============================================
    // Integration Management Functions
    // ============================================

    let integrationTypes = [];
    let integrations = [];
    let currentIntegration = null;
    let detectedSourceFields = [];

    // Load integrations when tab is shown
    document.querySelector('button[data-bs-target="#integrations"]')?.addEventListener('shown.bs.tab', function() {
        loadIntegrationTypes();
        loadIntegrations();
        loadApiKeys();
    });

    async function loadIntegrationTypes() {
        try {
            const response = await fetch('/api/integrations/types', { headers: getAuthHeaders() });
            const data = await response.json();
            integrationTypes = data.types || [];

            // Populate add integration modal dropdown
            const select = document.getElementById('newIntegrationType');
            if (select) {
                select.innerHTML = '<option value="">Select type...</option>' +
                    integrationTypes.map(t => `<option value="${t.type}">${t.name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading integration types:', error);
        }
    }

    async function loadIntegrations() {
        try {
            const response = await fetch('/api/integrations/', { headers: getAuthHeaders() });
            const data = await response.json();
            integrations = data.integrations || [];
            renderIntegrationsList();
        } catch (error) {
            console.error('Error loading integrations:', error);
            document.getElementById('integrationsList').innerHTML =
                '<div class="text-center p-3 text-danger">Error loading integrations</div>';
        }
    }

    function renderIntegrationsList() {
        const container = document.getElementById('integrationsList');
        if (!integrations.length) {
            container.innerHTML = '<div class="text-center p-3 text-muted">No integrations configured</div>';
            return;
        }

        container.innerHTML = integrations.map(int => {
            const typeInfo = integrationTypes.find(t => t.type === int.integration_type) || {};
            const statusBadge = getStatusBadge(int.status);
            return `
                <a href="#" class="list-group-item list-group-item-action ${currentIntegration?.id === int.id ? 'active' : ''}"
                   onclick="selectIntegration(${int.id}); return false;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi ${typeInfo.icon || 'bi-plug'} me-2"></i>
                            <strong>${int.name}</strong>
                        </div>
                        ${statusBadge}
                    </div>
                    <small class="text-muted">${typeInfo.name || int.integration_type}</small>
                </a>
            `;
        }).join('');
    }

    function getStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge bg-warning">Pending</span>',
            'active': '<span class="badge bg-success">Active</span>',
            'inactive': '<span class="badge bg-secondary">Inactive</span>',
            'error': '<span class="badge bg-danger">Error</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
    }

    async function selectIntegration(id) {
        try {
            const response = await fetch(`/api/integrations/${id}`, { headers: getAuthHeaders() });
            currentIntegration = await response.json();

            document.getElementById('noIntegrationSelected').style.display = 'none';
            document.getElementById('integrationDetailCard').style.display = 'block';

            renderIntegrationDetail();
            renderIntegrationsList(); // Update selection highlight
        } catch (error) {
            console.error('Error loading integration:', error);
            alert('Error loading integration details');
        }
    }

    function renderIntegrationDetail() {
        if (!currentIntegration) return;

        const typeInfo = integrationTypes.find(t => t.type === currentIntegration.integration_type) || {};

        // Header
        document.getElementById('integrationDetailName').textContent = currentIntegration.name;
        document.getElementById('integrationDetailType').textContent = typeInfo.name || currentIntegration.integration_type;

        const statusEl = document.getElementById('integrationDetailStatus');
        statusEl.innerHTML = getStatusBadge(currentIntegration.status);

        // Show/hide activate/deactivate buttons
        document.getElementById('activateBtn').style.display =
            currentIntegration.status !== 'active' ? 'inline-block' : 'none';
        document.getElementById('deactivateBtn').style.display =
            currentIntegration.status === 'active' ? 'inline-block' : 'none';

        // Azure recommendation
        if (typeInfo.azure_recommendation) {
            document.getElementById('azureRecommendation').style.display = 'block';
            document.getElementById('azureRecommendationText').textContent = typeInfo.azure_recommendation;
        } else {
            document.getElementById('azureRecommendation').style.display = 'none';
        }

        // Webhook URL
        document.getElementById('webhookUrl').value =
            `${window.location.origin}/api/integrations/webhook/${currentIntegration.id}`;

        // Config fields
        renderConfigFields(typeInfo.config_fields || [], currentIntegration.config || {});

        // Field mapping
        renderFieldMapping(currentIntegration.field_mapping || {});

        // Statistics
        document.getElementById('statReceived').textContent = `${currentIntegration.total_received || 0} received`;
        document.getElementById('statProcessed').textContent = `${currentIntegration.total_processed || 0} processed`;
        document.getElementById('statErrors').textContent = `${currentIntegration.total_errors || 0} errors`;

        // Load logs
        loadIntegrationLogs(currentIntegration.id);
    }

    function renderConfigFields(fields, values) {
        const container = document.getElementById('configFieldsContainer');
        if (!fields.length) {
            container.innerHTML = '<p class="text-muted">No configuration required for this integration type.</p>';
            return;
        }

        container.innerHTML = fields.map(field => {
            const value = values[field.key] || field.default || '';
            let input = '';

            switch (field.type) {
                case 'select':
                    input = `<select class="form-select" id="config_${field.key}" name="${field.key}">
                        ${(field.options || []).map(opt =>
                            `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`
                        ).join('')}
                    </select>`;
                    break;
                case 'boolean':
                    input = `<div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="config_${field.key}" name="${field.key}"
                               ${value === true || value === 'true' ? 'checked' : ''}>
                    </div>`;
                    break;
                case 'password':
                    input = `<input type="password" class="form-control" id="config_${field.key}" name="${field.key}"
                             value="${value}" placeholder="">`;
                    break;
                case 'number':
                    input = `<input type="number" class="form-control" id="config_${field.key}" name="${field.key}"
                             value="${value}">`;
                    break;
                default:
                    input = `<input type="${field.type || 'text'}" class="form-control" id="config_${field.key}"
                             name="${field.key}" value="${value}" placeholder="${field.label}">`;
            }

            return `
                <div class="mb-3">
                    <label class="form-label">${field.label}${field.required ? ' <span class="text-danger">*</span>' : ''}</label>
                    ${input}
                </div>
            `;
        }).join('');
    }

    function renderFieldMapping(mapping) {
        const tbody = document.getElementById('fieldMappingBody');
        const docFields = [
            { key: 'accession_number', label: 'Accession Number' },
            { key: 'patient_name', label: 'Patient Name' },
            { key: 'patient_dob', label: 'Patient DOB' },
            { key: 'medical_record_number', label: 'Medical Record Number' },
            { key: 'ordering_physician', label: 'Ordering Physician' },
            { key: 'facility_name', label: 'Facility Name' },
            { key: 'facility_id', label: 'Facility ID' },
            { key: 'collection_date', label: 'Collection Date' },
            { key: 'specimen_type', label: 'Specimen Type' },
            { key: 'tests_requested', label: 'Tests Requested' },
            { key: 'special_instructions', label: 'Special Instructions' }
        ];

        const sourceOptions = detectedSourceFields.length ?
            detectedSourceFields.map(f => `<option value="${f}">${f}</option>`).join('') : '';

        tbody.innerHTML = docFields.map(field => `
            <tr>
                <td>${field.label}</td>
                <td>
                    <input type="text" class="form-control form-control-sm" id="mapping_${field.key}"
                           value="${mapping[field.key] || ''}" placeholder="Source field name..."
                           list="sourceFieldsList">
                </td>
            </tr>
        `).join('');

        // Add datalist for autocomplete if we have detected fields
        if (detectedSourceFields.length && !document.getElementById('sourceFieldsList')) {
            const datalist = document.createElement('datalist');
            datalist.id = 'sourceFieldsList';
            datalist.innerHTML = detectedSourceFields.map(f => `<option value="${f}">`).join('');
            document.body.appendChild(datalist);
        }
    }

    async function loadIntegrationLogs(id) {
        try {
            const response = await fetch(`/api/integrations/${id}/logs?limit=50`, { headers: getAuthHeaders() });
            const data = await response.json();

            const tbody = document.getElementById('integrationLogsBody');
            if (!data.logs?.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No logs yet</td></tr>';
                return;
            }

            tbody.innerHTML = data.logs.map(log => `
                <tr class="${log.success ? '' : 'table-danger'}">
                    <td>${formatLocalDate(log.created_at)}</td>
                    <td>${log.event_type}</td>
                    <td>${log.success ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-danger">Failed</span>'}</td>
                    <td class="small">${log.error_message || '-'}</td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading logs:', error);
        }
    }

    function showAddIntegrationModal() {
        loadIntegrationTypes();
        document.getElementById('addIntegrationForm').reset();
        document.getElementById('integrationTypeInfo').style.display = 'none';
        const modal = new bootstrap.Modal(document.getElementById('addIntegrationModal'));
        modal.show();
    }

    // Show type description when selected
    document.getElementById('newIntegrationType')?.addEventListener('change', function() {
        const typeInfo = integrationTypes.find(t => t.type === this.value);
        const infoDiv = document.getElementById('integrationTypeInfo');
        if (typeInfo) {
            document.getElementById('integrationTypeDesc').textContent = typeInfo.description;
            if (typeInfo.azure_recommendation) {
                document.getElementById('integrationTypeDesc').innerHTML +=
                    `<br><strong>Tip:</strong> ${typeInfo.azure_recommendation}`;
            }
            infoDiv.style.display = 'block';
        } else {
            infoDiv.style.display = 'none';
        }
    });

    async function createIntegration() {
        const name = document.getElementById('newIntegrationName').value;
        const description = document.getElementById('newIntegrationDesc').value;
        const type = document.getElementById('newIntegrationType').value;

        if (!name || !type) {
            alert('Please fill in required fields');
            return;
        }

        try {
            const response = await fetch('/api/integrations/', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ name, description, integration_type: type })
            });

            if (!response.ok) throw new Error('Failed to create integration');

            const integration = await response.json();
            bootstrap.Modal.getInstance(document.getElementById('addIntegrationModal')).hide();
            await loadIntegrations();
            selectIntegration(integration.id);
        } catch (error) {
            alert('Error creating integration: ' + error.message);
        }
    }

    async function saveIntegrationConfig() {
        if (!currentIntegration) return;

        const config = {};
        document.querySelectorAll('#configFieldsContainer input, #configFieldsContainer select').forEach(el => {
            if (el.type === 'checkbox') {
                config[el.name] = el.checked;
            } else {
                config[el.name] = el.value;
            }
        });

        try {
            const response = await fetch(`/api/integrations/${currentIntegration.id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ config })
            });

            if (!response.ok) throw new Error('Failed to save');
            alert('Configuration saved!');
            await selectIntegration(currentIntegration.id);
        } catch (error) {
            alert('Error saving configuration: ' + error.message);
        }
    }

    async function saveFieldMapping() {
        if (!currentIntegration) return;

        const fieldMapping = {};
        document.querySelectorAll('#fieldMappingBody input').forEach(el => {
            const key = el.id.replace('mapping_', '');
            fieldMapping[key] = el.value || null;
        });

        try {
            const response = await fetch(`/api/integrations/${currentIntegration.id}/field-mapping`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ field_mapping: fieldMapping })
            });

            if (!response.ok) throw new Error('Failed to save');
            alert('Field mapping saved!');
        } catch (error) {
            alert('Error saving field mapping: ' + error.message);
        }
    }

    async function activateIntegration() {
        if (!currentIntegration) return;
        if (!confirm('Activate this integration? Data will be processed into the document stream.')) return;

        try {
            const response = await fetch(`/api/integrations/${currentIntegration.id}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ status: 'active' })
            });

            if (!response.ok) throw new Error('Failed to activate');
            await selectIntegration(currentIntegration.id);
            await loadIntegrations();
        } catch (error) {
            alert('Error activating integration: ' + error.message);
        }
    }

    async function deactivateIntegration() {
        if (!currentIntegration) return;

        try {
            const response = await fetch(`/api/integrations/${currentIntegration.id}/status`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ status: 'inactive' })
            });

            if (!response.ok) throw new Error('Failed to deactivate');
            await selectIntegration(currentIntegration.id);
            await loadIntegrations();
        } catch (error) {
            alert('Error deactivating integration: ' + error.message);
        }
    }

    async function deleteIntegration() {
        if (!currentIntegration) return;
        if (!confirm(`Delete integration "${currentIntegration.name}"? This cannot be undone.`)) return;

        try {
            const response = await fetch(`/api/integrations/${currentIntegration.id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to delete');

            currentIntegration = null;
            document.getElementById('integrationDetailCard').style.display = 'none';
            document.getElementById('noIntegrationSelected').style.display = 'block';
            await loadIntegrations();
        } catch (error) {
            alert('Error deleting integration: ' + error.message);
        }
    }

    async function testSample() {
        if (!currentIntegration) return;

        let sampleData = document.getElementById('sampleDataInput').value;
        const fileInput = document.getElementById('sampleFileInput');

        // If file selected, read it
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            sampleData = await file.text();
        }

        if (!sampleData.trim()) {
            alert('Please paste sample data or upload a file');
            return;
        }

        try {
            const response = await fetch(`/api/integrations/${currentIntegration.id}/test-sample`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ sample_data: sampleData })
            });

            const result = await response.json();

            if (!response.ok) {
                alert('Test failed: ' + (result.detail || result.error || 'Unknown error'));
                return;
            }

            // Show results
            document.getElementById('sampleResults').style.display = 'block';

            // Update detected fields for autocomplete
            detectedSourceFields = result.raw_fields || [];
            document.getElementById('detectedFields').innerHTML =
                detectedSourceFields.map(f => `<li><code>${f}</code></li>`).join('');

            document.getElementById('mappedResult').textContent =
                JSON.stringify(result.mapped_data, null, 2);

            // Refresh field mapping with new detected fields
            renderFieldMapping(currentIntegration.field_mapping || {});

        } catch (error) {
            alert('Error testing sample: ' + error.message);
        }
    }

    function copyWebhookUrl() {
        const input = document.getElementById('webhookUrl');
        input.select();
        document.execCommand('copy');
        alert('Webhook URL copied to clipboard!');
    }

    // ============================================
    // API Key Management
    // ============================================

    async function loadApiKeys() {
        try {
            const response = await fetch('/api/integrations/api-keys/all', { headers: getAuthHeaders() });
            const data = await response.json();

            const container = document.getElementById('apiKeysList');
            if (!data.api_keys?.length) {
                container.innerHTML = '<div class="text-center p-2 text-muted small">No API keys yet</div>';
                return;
            }

            container.innerHTML = data.api_keys.map(key => `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <div>
                        <strong class="small">${key.name}</strong>
                        <br><code class="small">${key.key_prefix}...</code>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="revokeApiKey(${key.id})" title="Revoke">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `).join('');

            // Also update the API key dropdown in create modal
            const select = document.getElementById('newApiKeyIntegration');
            if (select && integrations.length) {
                select.innerHTML = '<option value="">None (General purpose key)</option>' +
                    integrations.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading API keys:', error);
        }
    }

    function showCreateApiKeyModal() {
        loadIntegrations(); // Refresh integration list for dropdown
        document.getElementById('createApiKeyForm').reset();
        document.getElementById('scopeDocsCreate').checked = true;
        document.getElementById('scopeWebhook').checked = true;
        const modal = new bootstrap.Modal(document.getElementById('createApiKeyModal'));
        modal.show();
    }

    async function createApiKey() {
        const name = document.getElementById('newApiKeyName').value;
        const description = document.getElementById('newApiKeyDesc').value;
        const integrationId = document.getElementById('newApiKeyIntegration').value;

        const scopes = [];
        if (document.getElementById('scopeDocsCreate').checked) scopes.push('documents:create');
        if (document.getElementById('scopeDocsRead').checked) scopes.push('documents:read');
        if (document.getElementById('scopeWebhook').checked) scopes.push('integrations:webhook');

        if (!name) {
            alert('Please enter a key name');
            return;
        }

        try {
            const response = await fetch('/api/integrations/api-keys', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    name,
                    description,
                    integration_id: integrationId ? parseInt(integrationId) : null,
                    scopes
                })
            });

            if (!response.ok) throw new Error('Failed to create API key');

            const result = await response.json();

            // Close create modal
            bootstrap.Modal.getInstance(document.getElementById('createApiKeyModal')).hide();

            // Show the key in the "key created" modal
            document.getElementById('createdApiKey').value = result.key;
            const keyModal = new bootstrap.Modal(document.getElementById('apiKeyCreatedModal'));
            keyModal.show();

            // Refresh list
            await loadApiKeys();
        } catch (error) {
            alert('Error creating API key: ' + error.message);
        }
    }

    function copyApiKey() {
        const input = document.getElementById('createdApiKey');
        input.select();
        document.execCommand('copy');
        alert('API key copied to clipboard!');
    }

    async function revokeApiKey(id) {
        if (!confirm('Revoke this API key? This cannot be undone and will break any integrations using it.')) return;

        try {
            const response = await fetch(`/api/integrations/api-keys/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to revoke');
            await loadApiKeys();
        } catch (error) {
            alert('Error revoking API key: ' + error.message);
        }
    }

    // ============================================
    // Storage Lifecycle Management Functions
    // ============================================

    // Load lifecycle config when tab is shown
    document.querySelector('button[data-bs-target="#storage"]')?.addEventListener('shown.bs.tab', function() {
        loadLifecycleConfig();
    });

    async function loadLifecycleConfig() {
        try {
            const response = await fetch('/api/queue/lifecycle/config', {
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to load lifecycle config');
            }

            const data = await response.json();
            const config = data.config;
            const exampleDates = data.example_dates;

            // Populate form fields
            document.getElementById('retentionYears').value = config.retention_years;
            document.getElementById('coolTierDays').value = config.cool_tier_days;
            document.getElementById('coldTierDays').value = config.cold_tier_days;
            document.getElementById('immutabilityEnabled').checked = config.immutability_enabled;
            document.getElementById('autoSyncEnabled').checked = config.auto_sync_enabled;

            // Update timeline preview
            document.getElementById('timeline-upload').textContent = formatDate(exampleDates.import_date);
            document.getElementById('timeline-cool').textContent = formatDate(exampleDates.cool_tier_date);
            document.getElementById('timeline-cold').textContent = formatDate(exampleDates.cold_tier_date);
            document.getElementById('timeline-expiry').textContent = formatDate(exampleDates.expiry_date);

        } catch (error) {
            console.error('Error loading lifecycle config:', error);
            alert('Error loading lifecycle configuration: ' + error.message);
        }
    }

    function formatDate(isoDate) {
        if (!isoDate) return 'N/A';
        const date = new Date(isoDate);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    async function saveLifecycleSettings() {
        const settings = [
            { key: 'DOCUMENT_RETENTION_YEARS', value: document.getElementById('retentionYears').value },
            { key: 'STORAGE_TIER_COOL_DAYS', value: document.getElementById('coolTierDays').value },
            { key: 'STORAGE_TIER_COLD_DAYS', value: document.getElementById('coldTierDays').value },
            { key: 'BLOB_IMMUTABILITY_ENABLED', value: document.getElementById('immutabilityEnabled').checked ? 'true' : 'false' },
            { key: 'STORAGE_LIFECYCLE_AUTO_SYNC', value: document.getElementById('autoSyncEnabled').checked ? 'true' : 'false' }
        ];

        try {
            let savedCount = 0;
            for (const setting of settings) {
                const response = await fetch(`/api/config/${setting.key}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ value: setting.value })
                });

                if (response.ok) {
                    savedCount++;
                }
            }

            alert(`Saved ${savedCount} of ${settings.length} settings successfully!`);

            // Reload to show updated timeline
            loadLifecycleConfig();

        } catch (error) {
            alert('Error saving settings: ' + error.message);
        }
    }

    async function syncAllMetadata() {
        if (!confirm('This will update blob metadata for all documents. Continue?')) {
            return;
        }

        try {
            const response = await fetch('/api/queue/lifecycle/sync-all', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to sync metadata');
            }

            const result = await response.json();

            // Show results
            document.getElementById('syncResults').style.display = 'block';
            document.getElementById('syncResultsContent').textContent = JSON.stringify(result, null, 2);

        } catch (error) {
            alert('Error syncing metadata: ' + error.message);
        }
    }

    async function generateLifecyclePolicy() {
        try {
            const response = await fetch('/api/queue/lifecycle/sync-policy', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (!response.ok) {
                throw new Error('Failed to generate policy');
            }

            const result = await response.json();

            // Show results
            document.getElementById('syncResults').style.display = 'block';
            document.getElementById('syncResultsContent').textContent = JSON.stringify(result, null, 2);

        } catch (error) {
            alert('Error generating policy: ' + error.message);
        }
    }

    // ============================================
    // Authentication & SSO Configuration Functions
    // ============================================

    // Load auth status when integrations tab is shown
    document.querySelector('button[data-bs-target="#integrations"]')?.addEventListener('shown.bs.tab', function() {
        loadAuthStatus();
    });

    // Also load on page load if integrations tab is active
    document.addEventListener('DOMContentLoaded', function() {
        if (document.querySelector('#integrations.active')) {
            loadAuthStatus();
            loadAiServicesStatus();
        }
    });

    // Load AI services status when integrations tab is shown
    document.querySelector('button[data-bs-target="#integrations"]')?.addEventListener('shown.bs.tab', function() {
        loadAiServicesStatus();
    });

    async function loadAiServicesStatus() {
        try {
            // Load from health endpoint
            const response = await fetch('/health/detailed', { headers: getAuthHeaders() });
            if (!response.ok) return;

            const data = await response.json();
            const services = data.services || {};

            // Update Document Intelligence status
            const docIntelService = services.document_intelligence;
            if (docIntelService) {
                updateDocIntelStatusDisplay(docIntelService);
            }

            // Update Azure OpenAI status
            const openAiService = services.azure_openai;
            if (openAiService) {
                updateOpenAiStatusDisplay(openAiService);
            }

            // Load checkbox states from config
            const configResponse = await fetch('/api/config/AI_SERVICE_CONFIG', { headers: getAuthHeaders() });
            if (configResponse.ok) {
                const configData = await configResponse.json();
                if (configData.value) {
                    // Handle both object and string values
                    const config = typeof configData.value === 'string'
                        ? JSON.parse(configData.value)
                        : configData.value;
                    document.getElementById('docIntelClassify').checked = config.doc_intel_classify !== false;
                    document.getElementById('openAiExtract').checked = config.openai_extract !== false;
                    document.getElementById('learningModeToggle').checked = config.learning_mode === true;
                    updateLearningModeUI(config.learning_mode === true);
                }
            } else {
                // Default: both enabled, learning off
                document.getElementById('docIntelClassify').checked = true;
                document.getElementById('openAiExtract').checked = true;
                document.getElementById('learningModeToggle').checked = false;
            }

            // Load training stats
            await loadTrainingStats();

        } catch (error) {
            console.error('Error loading AI services status:', error);
        }
    }

    function updateDocIntelStatusDisplay(service) {
        const statusBadge = document.getElementById('docIntelStatusBadge');
        const endpointEl = document.getElementById('docIntelEndpoint');
        const classifierEl = document.getElementById('docIntelClassifier');

        if (service.status === 'healthy') {
            statusBadge.innerHTML = '<span class="badge bg-success">Connected</span>';
        } else if (service.status === 'degraded') {
            // Degraded means not configured or missing credentials
            statusBadge.innerHTML = '<span class="badge bg-warning text-dark">Not Configured</span>';
        } else if (service.status === 'unhealthy') {
            // Unhealthy means configured but connection/auth failed
            const msg = service.message || 'Connection failed';
            statusBadge.innerHTML = `<span class="badge bg-danger" title="${msg}">Error</span>`;
        } else {
            // Unknown status
            statusBadge.innerHTML = '<span class="badge bg-secondary">Unknown</span>';
        }

        const details = service.details || {};
        endpointEl.textContent = details.endpoint || 'Not configured';
        classifierEl.textContent = details.classifier_id || 'None';
    }

    function updateOpenAiStatusDisplay(service) {
        const statusBadge = document.getElementById('openAiStatusBadge');
        const endpointEl = document.getElementById('openAiEndpoint');
        const deploymentEl = document.getElementById('openAiDeployment');

        if (service.status === 'healthy') {
            statusBadge.innerHTML = '<span class="badge bg-success">Connected</span>';
        } else if (service.status === 'degraded') {
            statusBadge.innerHTML = '<span class="badge bg-warning text-dark">Not Configured</span>';
        } else {
            statusBadge.innerHTML = '<span class="badge bg-danger">Error</span>';
        }

        const details = service.details || {};
        endpointEl.textContent = details.endpoint || 'Not configured';
        deploymentEl.textContent = details.deployment || '-';
    }

    async function saveAiServiceConfig() {
        const learningMode = document.getElementById('learningModeToggle').checked;
        const config = {
            doc_intel_classify: document.getElementById('docIntelClassify').checked,
            openai_extract: document.getElementById('openAiExtract').checked,
            learning_mode: learningMode
        };

        try {
            const response = await fetch('/api/config/AI_SERVICE_CONFIG', {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ value: JSON.stringify(config) })
            });

            if (response.ok) {
                showToast('AI service configuration saved', 'success');
                updateLearningModeUI(learningMode);
            } else {
                showToast('Failed to save configuration', 'danger');
            }
        } catch (error) {
            console.error('Error saving AI config:', error);
            showToast('Error saving configuration', 'danger');
        }
    }

    function updateLearningModeUI(enabled) {
        const detailsDiv = document.getElementById('learningModeDetails');
        const learningBadge = document.getElementById('learningBadge');
        const trainSection = document.getElementById('trainClassifierSection');

        if (enabled) {
            detailsDiv.style.display = 'block';
            learningBadge.style.display = 'inline';
            // Load stats to update training readiness
            loadTrainingStats();
        } else {
            detailsDiv.style.display = 'none';
            learningBadge.style.display = 'none';
            if (trainSection) trainSection.style.display = 'none';
        }
    }

    async function loadTrainingStats() {
        try {
            const response = await fetch('/api/scan/training/stats', { headers: getAuthHeaders() });
            if (response.ok) {
                const data = await response.json();
                const stats = data.stats || data;
                document.getElementById('learnedDocTypes').textContent = stats.document_types || 0;
                document.getElementById('learnedSamples').textContent = stats.total_samples || 0;
                document.getElementById('learnedFeatures').textContent = stats.total_features || 0;
                const docIntelSamples = document.getElementById('docIntelTrainingSamples');
                if (docIntelSamples) docIntelSamples.textContent = stats.total_samples || 0;

                // Update training readiness
                updateTrainingReadiness(stats);
            }

            // Also load extraction stats for FR percentage
            const extractionResponse = await fetch('/api/scan/training/extraction-stats', { headers: getAuthHeaders() });
            if (extractionResponse.ok) {
                const extractionStats = await extractionResponse.json();
                const frPctEl = document.getElementById('frExtractionPct');
                if (frPctEl) {
                    frPctEl.textContent = (extractionStats.fr_percentage || 0) + '%';
                }
            }
        } catch (error) {
            console.log('Training stats not available:', error);
        }
    }

    function updateTrainingReadiness(stats) {
        const section = document.getElementById('trainClassifierSection');
        const btn = document.getElementById('trainClassifierBtn');
        const readinessText = document.getElementById('trainingReadiness');

        if (!section) return;

        const docTypes = stats.document_types || 0;
        const samples = stats.total_samples || 0;

        // Show section if learning mode is enabled
        const learningEnabled = document.getElementById('learningModeToggle').checked;
        section.style.display = learningEnabled ? 'block' : 'none';

        // Check readiness: need at least 1 doc type and 5 samples
        const isReady = docTypes >= 1 && samples >= 5;

        btn.disabled = !isReady;

        if (isReady) {
            readinessText.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Ready! ${docTypes} document type(s), ${samples} training sample(s)</span>`;
        } else {
            const needed = [];
            if (docTypes < 1) needed.push('at least 1 document type');
            if (samples < 5) needed.push(`${5 - samples} more sample(s)`);
            readinessText.innerHTML = `<span class="text-muted">Need: ${needed.join(', ')}</span>`;
        }
    }

    // Document Type Management Functions
    let documentTypes = [];

    async function showDocumentTypesPanel() {
        try {
            const response = await fetch('/api/scan/training/document-types', { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load document types');

            const data = await response.json();
            documentTypes = data.document_types || [];

            // Also get extraction stats
            const statsResponse = await fetch('/api/scan/training/extraction-stats', { headers: getAuthHeaders() });
            const statsData = statsResponse.ok ? await statsResponse.json() : {};

            let html = `
                <div class="mb-3">
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="fs-5 fw-bold text-primary">${statsData.total_extractions || 0}</div>
                                <small class="text-muted">Total Extractions</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="fs-5 fw-bold text-success">${statsData.form_recognizer_extractions || 0}</div>
                                <small class="text-muted">Form Recognizer</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="fs-5 fw-bold text-info">${statsData.openai_extractions || 0}</div>
                                <small class="text-muted">OpenAI</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 text-center bg-light">
                                <div class="fs-5 fw-bold text-warning">${statsData.fallback_rate || 0}%</div>
                                <small class="text-muted">Fallback Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
                <h6 class="mb-3"><i class="bi bi-file-earmark-text"></i> Document Types (${documentTypes.length})</h6>
            `;

            if (documentTypes.length > 0) {
                html += '<div class="document-types-list">';
                documentTypes.forEach(dt => {
                    const totalExtractions = (dt.fr_extraction_count || 0) + (dt.openai_extraction_count || 0);
                    const frPct = totalExtractions > 0 ? Math.round((dt.fr_extraction_count || 0) / totalExtractions * 100) : 0;

                    html += `
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">
                                            <i class="bi bi-file-earmark-text me-1"></i>
                                            ${dt.name}
                                            ${!dt.is_active ? '<span class="badge bg-secondary ms-2">Inactive</span>' : ''}
                                        </h6>
                                        <small class="text-muted">${dt.description || 'No description'}</small>
                                        <div class="mt-2">
                                            <span class="badge bg-primary me-1">${dt.sample_count} samples</span>
                                            <span class="badge bg-success me-1">${dt.verified_count || 0} verified</span>
                                            <span class="badge bg-info me-1">Avg: ${(dt.avg_confidence * 100).toFixed(0)}%</span>
                                            ${totalExtractions > 0 ? '<span class="badge bg-warning text-dark">FR: ' + frPct + '%</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="training_${dt.id}"
                                                ${dt.training_enabled ? 'checked' : ''}
                                                onchange="toggleDocTypeTraining(${dt.id}, this.checked)">
                                            <label class="form-check-label small" for="training_${dt.id}">Training</label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="fr_${dt.id}"
                                                ${dt.use_form_recognizer ? 'checked' : ''}
                                                onchange="toggleDocTypeFR(${dt.id}, this.checked)"
                                                ${!dt.form_recognizer_model_id ? 'disabled' : ''}>
                                            <label class="form-check-label small" for="fr_${dt.id}">Use FR</label>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewDocTypeDetails(${dt.id})">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteDocType(${dt.id}, '${dt.name.replace(/'/g, "\\'")}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                ${dt.form_recognizer_model_id ? '<div class="mt-2 pt-2 border-top"><small class="text-muted"><i class="bi bi-cpu"></i> FR Model: <code>' + dt.form_recognizer_model_id + '</code> | Threshold: ' + (dt.fr_confidence_threshold * 100).toFixed(0) + '% | Fallbacks: ' + (dt.openai_fallback_count || 0) + '</small></div>' : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html += '<div class="alert alert-info"><i class="bi bi-info-circle"></i> No document types learned yet. Enable learning mode and scan some documents to start training.</div>';
            }

            const modal = document.createElement('div');
            modal.innerHTML = '<div class="modal fade" tabindex="-1" id="docTypesModal"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-mortarboard"></i> Document Type Management</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">' + html + '</div><div class="modal-footer"><button class="btn btn-outline-secondary" onclick="refreshDocTypesPanel()"><i class="bi bi-arrow-clockwise"></i> Refresh</button><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>';

            document.getElementById('docTypesModal')?.remove();
            document.body.appendChild(modal);
            new bootstrap.Modal(document.getElementById('docTypesModal')).show();

        } catch (error) {
            console.error('Error loading document types:', error);
            showToast('Failed to load document types', 'danger');
        }
    }

    async function refreshDocTypesPanel() {
        bootstrap.Modal.getInstance(document.getElementById('docTypesModal'))?.hide();
        setTimeout(() => showDocumentTypesPanel(), 300);
    }

    async function toggleDocTypeTraining(typeId, enabled) {
        try {
            const response = await fetch('/api/scan/training/document-types/' + typeId, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ training_enabled: enabled })
            });
            if (!response.ok) throw new Error('Failed to update');
            showToast('Training ' + (enabled ? 'enabled' : 'disabled') + ' for document type', 'success');
        } catch (error) {
            console.error('Error:', error);
            showToast('Failed to update training setting', 'danger');
            document.getElementById('training_' + typeId).checked = !enabled;
        }
    }

    async function toggleDocTypeFR(typeId, enabled) {
        try {
            const response = await fetch('/api/scan/training/document-types/' + typeId, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify({ use_form_recognizer: enabled })
            });
            if (!response.ok) throw new Error('Failed to update');
            showToast('Form Recognizer ' + (enabled ? 'enabled' : 'disabled') + ' for document type', 'success');
        } catch (error) {
            console.error('Error:', error);
            showToast('Failed to update Form Recognizer setting', 'danger');
            document.getElementById('fr_' + typeId).checked = !enabled;
        }
    }

    async function viewDocTypeDetails(typeId) {
        try {
            const response = await fetch('/api/scan/training/document-types/' + typeId, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load details');

            const dt = await response.json();
            let samplesHtml = '';
            if (dt.samples && dt.samples.length > 0) {
                samplesHtml = '<h6 class="mt-3">Recent Samples (' + dt.samples.length + ')</h6><div class="table-responsive"><table class="table table-sm"><thead><tr><th>ID</th><th>Classification</th><th>Confidence</th><th>Verified</th><th>Date</th></tr></thead><tbody>';
                dt.samples.forEach(s => {
                    samplesHtml += '<tr><td>' + s.id + '</td><td>' + s.gpt_classification + '</td><td>' + (s.gpt_confidence * 100).toFixed(0) + '%</td><td>' + (s.is_verified ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-circle text-muted"></i>') + '</td><td>' + (s.created_at ? new Date(s.created_at).toLocaleDateString() : '-') + '</td></tr>';
                });
                samplesHtml += '</tbody></table></div>';
            }

            const html = '<div class="row"><div class="col-md-6"><h6>Basic Info</h6><dl class="row"><dt class="col-sm-5">Name</dt><dd class="col-sm-7">' + dt.name + '</dd><dt class="col-sm-5">Description</dt><dd class="col-sm-7">' + (dt.description || '-') + '</dd><dt class="col-sm-5">Status</dt><dd class="col-sm-7">' + (dt.is_active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>') + '</dd><dt class="col-sm-5">Training</dt><dd class="col-sm-7">' + (dt.training_enabled ? '<span class="badge bg-primary">Enabled</span>' : '<span class="badge bg-warning">Disabled</span>') + '</dd></dl></div><div class="col-md-6"><h6>Statistics</h6><dl class="row"><dt class="col-sm-5">Samples</dt><dd class="col-sm-7">' + dt.sample_count + '</dd><dt class="col-sm-5">Avg Confidence</dt><dd class="col-sm-7">' + (dt.avg_confidence * 100).toFixed(1) + '%</dd><dt class="col-sm-5">FR Extractions</dt><dd class="col-sm-7">' + (dt.fr_extraction_count || 0) + '</dd><dt class="col-sm-5">OpenAI Extractions</dt><dd class="col-sm-7">' + (dt.openai_extraction_count || 0) + '</dd><dt class="col-sm-5">Fallbacks</dt><dd class="col-sm-7">' + (dt.openai_fallback_count || 0) + '</dd></dl></div></div>' + (dt.form_recognizer_model_id ? '<div class="alert alert-info mt-3"><strong>Form Recognizer Model:</strong> ' + dt.form_recognizer_model_id + '<br><strong>Confidence Threshold:</strong> ' + (dt.fr_confidence_threshold * 100).toFixed(0) + '%</div>' : '') + samplesHtml;

            const modal = document.createElement('div');
            modal.innerHTML = '<div class="modal fade" tabindex="-1" id="docTypeDetailModal"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-file-earmark-text"></i> ' + dt.name + '</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">' + html + '</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div></div></div></div>';

            document.getElementById('docTypeDetailModal')?.remove();
            document.body.appendChild(modal);
            new bootstrap.Modal(document.getElementById('docTypeDetailModal')).show();
        } catch (error) {
            console.error('Error:', error);
            showToast('Failed to load document type details', 'danger');
        }
    }

    async function deleteDocType(typeId, typeName) {
        if (!confirm('Are you sure you want to deactivate "' + typeName + '"? This will stop training for this document type.')) return;
        try {
            const response = await fetch('/api/scan/training/document-types/' + typeId, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (!response.ok) throw new Error('Failed to delete');
            showToast('Document type "' + typeName + '" deactivated', 'success');
            refreshDocTypesPanel();
        } catch (error) {
            console.error('Error:', error);
            showToast('Failed to deactivate document type', 'danger');
        }
    }

    // Legacy function - redirect to new panel
    async function viewLearnedTypes() {
        showDocumentTypesPanel();
    }

    async function exportTrainingData() {
        try {
            const response = await fetch('/api/scan/training/export', { headers: getAuthHeaders() });
            if (response.ok) {
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `training_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Training data exported', 'success');
            }
        } catch (error) {
            showToast('Failed to export training data', 'danger');
        }
    }

    async function clearTrainingData() {
        if (!confirm('Are you sure you want to clear all training data? This cannot be undone.')) return;

        try {
            const response = await fetch('/api/scan/training/clear', {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if (response.ok) {
                showToast('Training data cleared', 'success');
                await loadTrainingStats();
            }
        } catch (error) {
            showToast('Failed to clear training data', 'danger');
        }
    }

    async function trainClassifierAndDisable() {
        if (!confirm('This will:\n\n1. Build a Document Intelligence classifier from learned data\n2. Disable learning mode\n\nThe classifier build may take several minutes. Continue?')) return;

        const btn = document.getElementById('trainClassifierBtn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Building Classifier...';

        try {
            const response = await fetch('/api/scan/training/build-classifier', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showToast(`Classifier built successfully! ${data.document_types_trained} document types trained.`, 'success');

                // Update UI - disable learning toggle
                document.getElementById('learningModeToggle').checked = false;
                updateLearningModeUI(false);

                // Show the new classifier ID
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="modal fade" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-check-circle"></i> Classifier Built Successfully</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Classifier ID:</strong><br><code>${data.classifier_id}</code></p>
                                    <p><strong>Document Types Trained:</strong> ${data.document_types_trained}</p>
                                    <p class="text-success"><i class="bi bi-check-circle"></i> Learning mode has been disabled.</p>
                                    <p class="text-muted small">The classifier is now active and will be used for document classification during scanning.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Done</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(modal);
                const bsModal = new bootstrap.Modal(modal.querySelector('.modal'));
                bsModal.show();
                modal.querySelector('.modal').addEventListener('hidden.bs.modal', () => modal.remove());

                // Reload config to reflect changes
                await loadAiServiceConfig();
            } else {
                showToast('Classifier build failed: ' + (data.detail || data.error || 'Unknown error'), 'danger');
            }
        } catch (error) {
            showToast('Failed to build classifier: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function testDocIntelConnection() {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

        try {
            const response = await fetch('/health/detailed', { headers: getAuthHeaders() });
            const data = await response.json();
            const service = data.services?.document_intelligence;

            if (service?.status === 'healthy') {
                showToast('Document Intelligence connection successful!', 'success');
            } else {
                showToast('Connection failed: ' + (service?.message || 'Unknown error'), 'danger');
            }
        } catch (error) {
            showToast('Test failed: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Test';
        }
    }

    async function testOpenAiConnection() {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';

        try {
            const response = await fetch('/health/detailed', { headers: getAuthHeaders() });
            const data = await response.json();
            const service = data.services?.azure_openai;

            if (service?.status === 'healthy') {
                showToast('Azure OpenAI connection successful!', 'success');
            } else {
                showToast('Connection failed: ' + (service?.message || 'Unknown error'), 'danger');
            }
        } catch (error) {
            showToast('Test failed: ' + error.message, 'danger');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Test';
        }
    }

    function showDocIntelConfigModal() {
        alert('Document Intelligence configuration: Set AZURE_DOC_INTELLIGENCE_ENDPOINT and AZURE_DOC_INTELLIGENCE_KEY in application settings.');
    }

    function showOpenAiConfigModal() {
        alert('Azure OpenAI configuration: Set AZURE_OPENAI_ENDPOINT, AZURE_OPENAI_API_KEY, and AZURE_OPENAI_DEPLOYMENT_NAME in application settings.');
    }

    async function loadAuthStatus() {
        try {
            // Load SSO status
            const ssoResponse = await fetch('/api/auth/sso/status', { headers: getAuthHeaders() });
            if (ssoResponse.ok) {
                const ssoData = await ssoResponse.json();
                updateSsoStatusDisplay(ssoData);
            }

            // Load SCIM status
            const scimResponse = await fetch('/api/auth/scim/status', { headers: getAuthHeaders() });
            if (scimResponse.ok) {
                const scimData = await scimResponse.json();
                updateScimStatusDisplay(scimData);
            }

            // Load role mapping status
            const roleResponse = await fetch('/api/auth/config', { headers: getAuthHeaders() });
            if (roleResponse.ok) {
                const roleData = await roleResponse.json();
                updateRoleMappingDisplay(roleData);
            }

        } catch (error) {
            console.error('Error loading auth status:', error);
        }
    }

    function updateSsoStatusDisplay(data) {
        const statusBadge = document.getElementById('ssoStatusBadge');
        const methodEl = document.getElementById('ssoMethod');
        const tenantIdEl = document.getElementById('ssoTenantId');
        const clientIdEl = document.getElementById('ssoClientId');

        if (data.sso_enabled && data.entra_id_configured) {
            statusBadge.innerHTML = '<span class="badge bg-success">Configured</span>';
        } else if (data.sso_enabled) {
            statusBadge.innerHTML = '<span class="badge bg-warning text-dark">Partial</span>';
        } else {
            statusBadge.innerHTML = '<span class="badge bg-secondary">Disabled</span>';
        }

        methodEl.textContent = data.sso_method ? data.sso_method.toUpperCase() : '-';
        tenantIdEl.textContent = data.tenant_id ? data.tenant_id.substring(0, 8) + '...' : 'Not set';
        clientIdEl.textContent = data.client_id ? data.client_id.substring(0, 8) + '...' : 'Not set';
    }

    function updateScimStatusDisplay(data) {
        const statusBadge = document.getElementById('scimStatusBadgeInteg');
        const userCount = document.getElementById('scimUserCount');
        const lastSync = document.getElementById('scimLastSync');

        if (data.scim_configured) {
            statusBadge.innerHTML = '<span class="badge bg-success">Configured</span>';
        } else {
            statusBadge.innerHTML = '<span class="badge bg-secondary">Not Configured</span>';
        }

        userCount.textContent = data.entra_id_users || '0';
        lastSync.textContent = data.last_sync ? new Date(data.last_sync).toLocaleDateString() : 'Never';
    }

    function updateRoleMappingDisplay(data) {
        const statusBadge = document.getElementById('roleMappingStatus');
        const adminStatus = document.getElementById('adminGroupStatus');
        const reviewerStatus = document.getElementById('reviewerGroupStatus');
        const userStatus = document.getElementById('userGroupStatus');

        let groupsConfigured = 0;
        if (data.admin_group_id) groupsConfigured++;
        if (data.reviewer_group_id) groupsConfigured++;
        if (data.user_group_id) groupsConfigured++;

        if (groupsConfigured === 3) {
            statusBadge.innerHTML = '<span class="badge bg-success">Configured</span>';
        } else if (groupsConfigured > 0) {
            statusBadge.innerHTML = '<span class="badge bg-warning text-dark">Partial (' + groupsConfigured + '/3)</span>';
        } else {
            statusBadge.innerHTML = '<span class="badge bg-secondary">Not Configured</span>';
        }

        adminStatus.className = data.admin_group_id ? 'badge bg-success' : 'badge bg-secondary';
        adminStatus.textContent = data.admin_group_id ? 'Set' : 'Not set';

        reviewerStatus.className = data.reviewer_group_id ? 'badge bg-success' : 'badge bg-secondary';
        reviewerStatus.textContent = data.reviewer_group_id ? 'Set' : 'Not set';

        if (userStatus) {
            userStatus.className = data.user_group_id ? 'badge bg-success' : 'badge bg-secondary';
            userStatus.textContent = data.user_group_id ? 'Set' : 'Not set';
        }
    }

    // SSO Configuration Modal
    let selectedIdp = 'entra';

    function selectIdp(idp) {
        if (document.querySelector(`.idp-option[data-idp="${idp}"]`)?.classList.contains('disabled')) {
            return;
        }

        // Update selection UI
        document.querySelectorAll('.idp-option').forEach(el => el.classList.remove('selected'));
        document.querySelector(`.idp-option[data-idp="${idp}"]`)?.classList.add('selected');
        selectedIdp = idp;

        // Show/hide provider-specific config
        document.getElementById('entraConfig').style.display = idp === 'entra' ? 'block' : 'none';
    }

    async function showSsoConfigModal() {
        const modal = new bootstrap.Modal(document.getElementById('ssoConfigModal'));

        // Set default URLs
        const baseUrl = window.location.origin;
        document.getElementById('ssoRedirectUri').value = baseUrl + '/api/auth/callback';
        document.getElementById('samlEntityId').value = baseUrl;
        document.getElementById('samlAcsUrl').value = baseUrl + '/api/auth/saml/acs';
        document.getElementById('scimTenantUrl').value = baseUrl + '/scim/v2';

        // Load existing config
        try {
            const response = await fetch('/api/auth/config', { headers: getAuthHeaders() });
            if (response.ok) {
                const config = await response.json();
                document.getElementById('ssoMethodSelect').value = config.sso_method || 'saml';
                document.getElementById('ssoTenantIdInput').value = config.tenant_id || '';
                document.getElementById('ssoClientIdInput').value = config.client_id || '';
                document.getElementById('samlMetadataUrl').value = config.saml_metadata_url || '';
                document.getElementById('samlIdpCert').value = config.saml_idp_cert || '';

                // Toggle SAML/OIDC fields based on method
                toggleSsoMethod();
            }
        } catch (error) {
            console.error('Error loading SSO config:', error);
        }

        modal.show();
    }

    function toggleSsoMethod() {
        const method = document.getElementById('ssoMethodSelect').value;
        const samlFields = document.getElementById('samlFields');
        const clientSecretGroup = document.getElementById('clientSecretGroup');

        if (method === 'saml') {
            samlFields.style.display = 'block';
            clientSecretGroup.querySelector('label').innerHTML = 'Client Secret';
        } else {
            samlFields.style.display = 'none';
            clientSecretGroup.querySelector('label').innerHTML = 'Client Secret <span class="text-danger">*</span>';
        }
    }

    // Listen for SSO method changes
    document.getElementById('ssoMethodSelect')?.addEventListener('change', toggleSsoMethod);

    async function saveSsoConfig() {
        const config = {
            sso_method: document.getElementById('ssoMethodSelect').value,
            tenant_id: document.getElementById('ssoTenantIdInput').value,
            client_id: document.getElementById('ssoClientIdInput').value,
            client_secret: document.getElementById('ssoClientSecretInput').value || null,
            redirect_uri: document.getElementById('ssoRedirectUri').value,
            saml_entity_id: document.getElementById('samlEntityId').value,
            saml_acs_url: document.getElementById('samlAcsUrl').value,
            saml_metadata_url: document.getElementById('samlMetadataUrl').value,
            saml_idp_cert: document.getElementById('samlIdpCert').value || null
        };

        try {
            const response = await fetch('/api/auth/config/sso', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(config)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save SSO configuration');
            }

            alert('SSO configuration saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('ssoConfigModal')).hide();
            loadAuthStatus();

        } catch (error) {
            alert('Error saving SSO config: ' + error.message);
        }
    }

    async function testSsoConnection() {
        try {
            const response = await fetch('/api/auth/sso/test', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            const result = await response.json();

            if (result.success) {
                alert('SSO connection successful!\n\n' + (result.message || 'Configuration is valid.'));
            } else {
                alert('SSO connection failed:\n\n' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error testing SSO: ' + error.message);
        }
    }

    // SCIM Configuration Modal
    async function showScimConfigModal() {
        const modal = new bootstrap.Modal(document.getElementById('scimConfigModal'));

        // Set tenant URL
        const baseUrl = window.location.origin;
        document.getElementById('scimTenantUrl').value = baseUrl + '/scim/v2';

        // Load existing token status (not the actual token for security)
        try {
            const response = await fetch('/api/auth/scim/status', { headers: getAuthHeaders() });
            if (response.ok) {
                const data = await response.json();
                if (data.scim_configured) {
                    document.getElementById('scimSecretToken').placeholder = '';
                }
            }
        } catch (error) {
            console.error('Error loading SCIM status:', error);
        }

        modal.show();
    }

    async function saveScimConfig() {
        const token = document.getElementById('scimSecretToken').value;

        if (!token) {
            alert('Please enter or generate a SCIM token');
            return;
        }

        try {
            const response = await fetch('/api/auth/config/scim', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ scim_token: token })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save SCIM configuration');
            }

            alert('SCIM configuration saved successfully!\n\nNote: You will need to update the SCIM_BEARER_TOKEN environment variable with this value.');
            bootstrap.Modal.getInstance(document.getElementById('scimConfigModal')).hide();
            loadAuthStatus();

        } catch (error) {
            alert('Error saving SCIM config: ' + error.message);
        }
    }

    function generateScimToken() {
        // Generate a secure random token
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        const token = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        document.getElementById('scimSecretToken').value = token;
        document.getElementById('scimSecretToken').type = 'text';
    }

    async function testScimEndpointInteg() {
        try {
            const response = await fetch('/api/auth/scim/test', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            const result = await response.json();

            if (result.success) {
                alert('SCIM endpoint is responding correctly!\n\nEndpoint: ' + window.location.origin + '/scim/v2');
            } else {
                alert('SCIM endpoint test failed:\n\n' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error testing SCIM endpoint: ' + error.message);
        }
    }

    // Role Mapping Modal
    async function showRoleMappingModal() {
        const modal = new bootstrap.Modal(document.getElementById('roleMappingModal'));

        // Load existing config
        try {
            const response = await fetch('/api/auth/config', { headers: getAuthHeaders() });
            if (response.ok) {
                const config = await response.json();
                document.getElementById('adminGroupId').value = config.admin_group_id || '';
                document.getElementById('reviewerGroupId').value = config.reviewer_group_id || '';
                document.getElementById('userGroupId').value = config.user_group_id || '';
                // If group membership is required, show "deny" as selected
                if (config.require_group_membership) {
                    document.getElementById('defaultRole').value = 'deny';
                } else {
                    document.getElementById('defaultRole').value = config.default_role || 'read_only';
                }
            }
        } catch (error) {
            console.error('Error loading role mapping config:', error);
        }

        modal.show();
    }

    async function saveRoleMappingConfig() {
        const defaultRoleValue = document.getElementById('defaultRole').value;
        const requireGroupMembership = defaultRoleValue === 'deny';

        const config = {
            admin_group_id: document.getElementById('adminGroupId').value || null,
            reviewer_group_id: document.getElementById('reviewerGroupId').value || null,
            user_group_id: document.getElementById('userGroupId').value || null,
            default_role: requireGroupMembership ? 'read_only' : defaultRoleValue,
            require_group_membership: requireGroupMembership
        };

        try {
            const response = await fetch('/api/auth/config/roles', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(config)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to save role mapping');
            }

            alert('Role mapping saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('roleMappingModal')).hide();
            loadAuthStatus();

        } catch (error) {
            alert('Error saving role mapping: ' + error.message);
        }
    }

    // Auth Setup Guide Modal
    function showAuthSetupGuide() {
        const modal = new bootstrap.Modal(document.getElementById('authSetupGuideModal'));
        modal.show();
    }

    // Utility Functions
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.value || element.textContent;

        navigator.clipboard.writeText(text).then(() => {
            // Show brief feedback
            const btn = element.nextElementSibling;
            if (btn) {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => { btn.innerHTML = originalHtml; }, 1500);
            }
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    }

    function togglePassword(elementId) {
        const element = document.getElementById(elementId);
        const btn = element.nextElementSibling;
        const icon = btn.querySelector('i');

        if (element.type === 'password') {
            element.type = 'text';
            icon.classList.replace('bi-eye', 'bi-eye-slash');
        } else {
            element.type = 'password';
            icon.classList.replace('bi-eye-slash', 'bi-eye');
        }
    }

    // ============================================
    // Equipment Management Functions
    // ============================================

    async function loadScanningStations() {
        const tableBody = document.getElementById('stationsTableBody');
        try {
            const response = await fetch('/api/workstation/stations', { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load stations');

            const stations = await response.json();

            if (!stations || stations.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No scanning stations configured</td></tr>';
                return;
            }

            tableBody.innerHTML = stations.map(station => `
                <tr>
                    <td><strong>${escapeHtml(station.name)}</strong></td>
                    <td>${escapeHtml(station.location || '-')}</td>
                    <td>
                        ${station.is_active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editStation(${station.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStation(${station.id}, '${escapeHtml(station.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error loading stations:', error);
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Failed to load stations</td></tr>';
        }
    }

    async function loadLabelPrinters() {
        const tableBody = document.getElementById('printersTableBody');
        try {
            const response = await fetch('/api/print/printers', { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load printers');

            const data = await response.json();
            const printers = data.printers || [];

            if (!printers || printers.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No label printers configured</td></tr>';
                return;
            }

            tableBody.innerHTML = printers.map(printer => {
                const methodBadge = {
                    'universal_print': '<span class="badge bg-info"><i class="bi bi-cloud"></i> Universal Print</span>',
                    'direct_ip': '<span class="badge bg-warning text-dark"><i class="bi bi-ethernet"></i> Direct IP</span>',
                    'local': '<span class="badge bg-secondary"><i class="bi bi-usb-symbol"></i> Local</span>'
                }[printer.print_method] || '<span class="badge bg-secondary">Unknown</span>';

                return `
                <tr>
                    <td>
                        <strong>${escapeHtml(printer.name)}</strong>
                        <br><small class="text-muted">${escapeHtml(printer.label_size || '2x1"')}</small>
                    </td>
                    <td>${escapeHtml(printer.location || '-')}</td>
                    <td>
                        ${escapeHtml(printer.printer_type || '-')}
                        <br>${methodBadge}
                    </td>
                    <td>
                        ${printer.is_active !== false
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="testPrinter(${printer.id}, '${escapeHtml(printer.name)}')" title="Test Print">
                            <i class="bi bi-printer"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editPrinter(${printer.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePrinter(${printer.id}, '${escapeHtml(printer.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        } catch (error) {
            console.error('Error loading printers:', error);
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load printers</td></tr>';
        }
    }

    function togglePrinterMethodFields() {
        const method = document.getElementById('printerMethod').value;
        document.getElementById('universalPrintFields').style.display = method === 'universal_print' ? 'block' : 'none';
        document.getElementById('directIpFields').style.display = (method === 'direct_ip' || method === 'local') ? 'block' : 'none';
    }

    async function testPrinterConnection() {
        const method = document.getElementById('printerMethod').value;
        const universalPrintId = document.getElementById('printerUniversalPrintId').value;
        const connection = document.getElementById('printerConnection').value;

        if (method === 'universal_print' && !universalPrintId) {
            showToast('Please enter Universal Print ID', 'warning');
            return;
        }
        if ((method === 'direct_ip' || method === 'local') && !connection) {
            showToast('Please enter connection string', 'warning');
            return;
        }

        showToast('Connection test not yet implemented', 'info');
    }

    function showAddStationModal() {
        document.getElementById('stationModalTitle').textContent = 'Add Scanning Station';
        document.getElementById('stationId').value = '';
        document.getElementById('stationName').value = '';
        document.getElementById('stationLocation').value = '';
        document.getElementById('stationDescription').value = '';
        document.getElementById('stationActive').checked = true;
        new bootstrap.Modal(document.getElementById('stationModal')).show();
    }

    async function editStation(id) {
        try {
            const response = await fetch(`/api/workstation/stations/${id}`, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load station');

            const station = await response.json();

            document.getElementById('stationModalTitle').textContent = 'Edit Scanning Station';
            document.getElementById('stationId').value = station.id;
            document.getElementById('stationName').value = station.name;
            document.getElementById('stationLocation').value = station.location || '';
            document.getElementById('stationDescription').value = station.description || '';
            document.getElementById('stationActive').checked = station.is_active;

            new bootstrap.Modal(document.getElementById('stationModal')).show();
        } catch (error) {
            console.error('Error loading station:', error);
            alert('Failed to load station details');
        }
    }

    async function saveStation() {
        const id = document.getElementById('stationId').value;
        const data = {
            name: document.getElementById('stationName').value.trim(),
            location: document.getElementById('stationLocation').value.trim() || null,
            description: document.getElementById('stationDescription').value.trim() || null,
            is_active: document.getElementById('stationActive').checked
        };

        if (!data.name) {
            alert('Station name is required');
            return;
        }

        try {
            const url = id ? `/api/workstation/stations/${id}` : '/api/workstation/stations';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to save station');

            bootstrap.Modal.getInstance(document.getElementById('stationModal')).hide();
            loadScanningStations();
        } catch (error) {
            console.error('Error saving station:', error);
            alert('Failed to save scanning station');
        }
    }

    async function deleteStation(id, name) {
        if (!confirm(`Are you sure you want to delete the scanning station "${name}"?`)) return;

        try {
            const response = await fetch(`/api/workstation/stations/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to delete station');
            loadScanningStations();
        } catch (error) {
            console.error('Error deleting station:', error);
            alert('Failed to delete scanning station');
        }
    }

    function showAddPrinterModal() {
        document.getElementById('printerModalTitle').textContent = 'Add Label Printer';
        document.getElementById('printerId').value = '';
        document.getElementById('printerName').value = '';
        document.getElementById('printerLocation').value = '';
        document.getElementById('printerType').value = 'Zebra';
        document.getElementById('printerMethod').value = 'universal_print';
        document.getElementById('printerUniversalPrintId').value = '';
        document.getElementById('printerConnection').value = '';
        document.getElementById('printerLabelWidth').value = '2';
        document.getElementById('printerLabelHeight').value = '1';
        document.getElementById('printerDpi').value = '203';
        document.getElementById('printerActive').checked = true;
        togglePrinterMethodFields();
        new bootstrap.Modal(document.getElementById('printerModal')).show();
    }

    async function editPrinter(id) {
        try {
            const response = await fetch(`/api/print/printers/${id}`, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('Failed to load printer');

            const printer = await response.json();

            document.getElementById('printerModalTitle').textContent = 'Edit Label Printer';
            document.getElementById('printerId').value = printer.id;
            document.getElementById('printerName').value = printer.name;
            document.getElementById('printerLocation').value = printer.location || '';
            document.getElementById('printerType').value = printer.printer_type || 'Zebra';
            document.getElementById('printerMethod').value = printer.print_method || 'universal_print';
            document.getElementById('printerUniversalPrintId').value = printer.universal_print_id || '';
            document.getElementById('printerConnection').value = printer.connection_string || '';
            document.getElementById('printerLabelWidth').value = printer.label_width_inches || '2';
            document.getElementById('printerLabelHeight').value = printer.label_height_inches || '1';
            document.getElementById('printerDpi').value = printer.label_width_dpi || '203';
            document.getElementById('printerActive').checked = printer.is_active !== false;
            togglePrinterMethodFields();

            new bootstrap.Modal(document.getElementById('printerModal')).show();
        } catch (error) {
            console.error('Error loading printer:', error);
            showToast('Failed to load printer details', 'danger');
        }
    }

    async function savePrinter() {
        const id = document.getElementById('printerId').value;
        const data = {
            name: document.getElementById('printerName').value.trim(),
            location: document.getElementById('printerLocation').value.trim() || null,
            printer_type: document.getElementById('printerType').value || null,
            print_method: document.getElementById('printerMethod').value,
            universal_print_id: document.getElementById('printerUniversalPrintId').value.trim() || null,
            connection_string: document.getElementById('printerConnection').value.trim() || null,
            label_width_inches: document.getElementById('printerLabelWidth').value || '2',
            label_height_inches: document.getElementById('printerLabelHeight').value || '1',
            label_width_dpi: parseInt(document.getElementById('printerDpi').value) || 203,
            is_active: document.getElementById('printerActive').checked
        };

        if (!data.name) {
            showToast('Printer name is required', 'warning');
            return;
        }

        try {
            const url = id ? `/api/print/printers/${id}` : '/api/print/printers';
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error('Failed to save printer');

            bootstrap.Modal.getInstance(document.getElementById('printerModal')).hide();
            loadLabelPrinters();
            showToast('Printer saved successfully', 'success');
        } catch (error) {
            console.error('Error saving printer:', error);
            showToast('Failed to save label printer', 'danger');
        }
    }

    async function deletePrinter(id, name) {
        if (!confirm(`Are you sure you want to delete the label printer "${name}"?`)) return;

        try {
            const response = await fetch(`/api/print/printers/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (!response.ok) throw new Error('Failed to delete printer');
            loadLabelPrinters();
            showToast('Printer deleted', 'success');
        } catch (error) {
            console.error('Error deleting printer:', error);
            showToast('Failed to delete label printer', 'danger');
        }
    }

    async function testPrinter(id, name) {
        showToast(`Generating test label for ${name}...`, 'info');

        try {
            const response = await fetch(`/api/print/test/${id}`, {
                method: 'POST',
                headers: getAuthHeaders()
            });

            const data = await response.json();

            if (!response.ok) {
                showToast(data.detail || 'Test print failed', 'danger');
                return;
            }

            // Add printer ID to data for alignment test button
            data.printer_id = id;

            // Show result modal with ZPL preview
            showTestPrintResult(data);

        } catch (error) {
            console.error('Error testing printer:', error);
            showToast('Failed to generate test label', 'danger');
        }
    }

    function showTestPrintResult(data) {
        const modal = document.createElement('div');
        const statusIcon = data.success
            ? '<i class="bi bi-check-circle-fill text-success"></i>'
            : '<i class="bi bi-exclamation-triangle-fill text-warning"></i>';

        modal.innerHTML = `
            <div class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${statusIcon} Test Print: ${escapeHtml(data.printer)}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-${data.success ? 'success' : 'warning'}">
                                <strong>${data.message}</strong>
                                ${data.note ? `<br><small class="text-muted">${data.note}</small>` : ''}
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><strong>Print Method:</strong></label>
                                <span class="badge bg-info ms-2">${data.print_method || 'unknown'}</span>
                                ${data.universal_print_id ? `<br><small class="text-muted">ID: ${data.universal_print_id}</small>` : ''}
                                ${data.connection ? `<br><small class="text-muted">Connection: ${data.connection}</small>` : ''}
                            </div>

                            <div class="mb-3">
                                <label class="form-label d-flex justify-content-between align-items-center">
                                    <strong>ZPL Commands:</strong>
                                    <button class="btn btn-sm btn-outline-primary" onclick="copyZplToClipboard()">
                                        <i class="bi bi-clipboard"></i> Copy ZPL
                                    </button>
                                </label>
                                <textarea class="form-control font-monospace" id="testZplOutput" rows="10" readonly>${escapeHtml(data.zpl || '')}</textarea>
                            </div>

                            <div class="alert alert-info">
                                <i class="bi bi-lightbulb"></i> <strong>Preview your label:</strong>
                                <br>Copy the ZPL above and paste it at <a href="http://labelary.com/viewer.html" target="_blank">Labelary.com</a> to see a preview.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" onclick="testPrinterAlignment(${data.printer_id || 0})">
                                <i class="bi bi-grid-3x3"></i> Alignment Test
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>`;

        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal.querySelector('.modal'));
        bsModal.show();
        modal.querySelector('.modal').addEventListener('hidden.bs.modal', () => modal.remove());
    }

    function copyZplToClipboard() {
        const textarea = document.getElementById('testZplOutput');
        if (textarea) {
            textarea.select();
            document.execCommand('copy');
            showToast('ZPL copied to clipboard', 'success');
        }
    }

    async function testPrinterAlignment(printerId) {
        if (!printerId) return;

        try {
            const response = await fetch(`/api/print/test/${printerId}/alignment`, {
                headers: getAuthHeaders()
            });

            const data = await response.json();

            if (data.zpl) {
                document.getElementById('testZplOutput').value = data.zpl;
                showToast('Alignment test pattern loaded', 'info');
            }
        } catch (error) {
            showToast('Failed to generate alignment test', 'danger');
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

<style>
    /* Admin page theme support */
    .card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }

    .card-header {
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .card-body {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    /* Tabs styling */
    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
    }

    .nav-tabs .nav-link {
        color: var(--text-secondary);
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link:hover {
        color: var(--mv-green);
        border-color: transparent;
    }

    .nav-tabs .nav-link.active {
        background: transparent;
        color: var(--mv-green);
        border-color: var(--mv-green);
    }

    /* Table styling */
    .table {
        color: var(--text-primary);
    }

    .table thead th {
        background: var(--table-header-bg);
        color: var(--text-secondary);
        border-bottom: 2px solid var(--border-color);
    }

    .table tbody td {
        border-bottom: 1px solid var(--border-color);
    }

    .table-hover tbody tr:hover {
        background: var(--table-row-hover);
    }

    /* Form controls */
    .form-control, .form-select {
        background-color: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .form-control:focus, .form-select:focus {
        background-color: var(--input-bg);
        border-color: var(--mv-green);
        color: var(--text-primary);
        box-shadow: 0 0 0 0.2rem rgba(139, 197, 63, 0.25);
    }

    .form-control::placeholder {
        color: var(--text-secondary);
    }

    /* List group */
    .list-group-item {
        background: var(--bg-secondary);
        border-color: var(--border-color);
        color: var(--text-primary);
    }

    .list-group-item:hover {
        background: var(--table-row-hover);
    }

    .list-group-item.active {
        background: var(--mv-green);
        border-color: var(--mv-green);
    }

    /* Alert styling */
    .alert-info {
        background: rgba(6, 182, 212, 0.1);
        border: 1px solid rgba(6, 182, 212, 0.3);
        color: var(--text-primary);
    }

    .alert-light {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    /* Pre/code blocks */
    pre {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 1rem;
        border-radius: 6px;
    }

    /* Modal styling */
    .modal-content {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }

    .modal-header {
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .modal-footer {
        border-top: 1px solid var(--border-color);
    }

    /* Button styling */
    .btn-primary {
        background-color: var(--mv-green);
        border-color: var(--mv-green);
    }

    .btn-primary:hover {
        background-color: var(--mv-green-dark);
        border-color: var(--mv-green-dark);
    }

    .btn-outline-primary {
        color: var(--mv-green);
        border-color: var(--mv-green);
    }

    .btn-outline-primary:hover {
        background-color: var(--mv-green);
        border-color: var(--mv-green);
        color: white;
    }

    /* Text utilities */
    .text-muted {
        color: var(--text-secondary) !important;
    }

    h2, h5, h6 {
        color: var(--text-primary);
    }

    /* Border utilities */
    .border-bottom {
        border-color: var(--border-color) !important;
    }

    .border {
        border-color: var(--border-color) !important;
    }

    /* Timeline styles for lifecycle preview */
    .timeline {
        position: relative;
        padding-left: 40px;
    }
    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }
    .timeline-item {
        position: relative;
        padding-bottom: 20px;
    }
    .timeline-badge {
        position: absolute;
        left: -40px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }
    .timeline-content h6 {
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--text-primary);
    }
    .timeline-content p {
        font-weight: 500;
        color: var(--text-secondary);
    }
</style>
{% endblock %}
