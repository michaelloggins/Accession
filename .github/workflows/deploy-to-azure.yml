# Azure App Service Deployment Workflow
# Deploys to app-accession-dev.azurewebsites.net on push to main
# Includes pre-flight checks to avoid deployment conflicts

name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      health_check:
        description: 'Run health check after deploy'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  AZURE_WEBAPP_NAME: app-accession-dev
  RESOURCE_GROUP: rg-accession-dev
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Create deployment package
      run: |
        # Fast zip without installing dependencies (Azure handles this)
        zip -r deploy.zip . \
          -x "*.git*" \
          -x "__pycache__/*" \
          -x "*.pyc" \
          -x "*.pyo" \
          -x ".env" \
          -x "venv/*" \
          -x ".venv/*" \
          -x "node_modules/*" \
          -x "*.log" \
          -x "webapp_logs*/*" \
          -x ".github/*" \
          -x "tests/*" \
          -x "deploy.zip"

        echo "üì¶ Package size: $(du -h deploy.zip | cut -f1)"

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Pre-flight checks
      run: |
        echo "üîç Running pre-flight checks..."

        # Check 1: App state
        echo "Checking app state..."
        app_state=$(az webapp show \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --query "state" -o tsv 2>/dev/null || echo "Unknown")

        echo "App state: $app_state"

        if [ "$app_state" != "Running" ]; then
          echo "‚ö†Ô∏è App not in Running state - waiting 30s for it to stabilize..."
          sleep 30
        fi

        # Check 2: Active deployments
        echo "Checking for active deployments..."
        deployment_status=$(az webapp deployment list \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --query "[0].status" -o tsv 2>/dev/null || echo "0")

        # Status 4 = in progress
        if [ "$deployment_status" = "4" ]; then
          echo "‚ö†Ô∏è Another deployment in progress - waiting 60s..."
          sleep 60

          # Check again
          deployment_status=$(az webapp deployment list \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --query "[0].status" -o tsv 2>/dev/null || echo "0")

          if [ "$deployment_status" = "4" ]; then
            echo "‚ö†Ô∏è Deployment still in progress - waiting another 60s..."
            sleep 60
          fi
        fi

        # Check 3: SCM site accessible
        echo "Checking SCM site accessibility..."
        scm_code=$(curl -s -o /dev/null -w "%{http_code}" \
          --connect-timeout 10 \
          --max-time 15 \
          https://${{ env.AZURE_WEBAPP_NAME }}.scm.azurewebsites.net/ 2>/dev/null || echo "000")

        # 401 is expected (auth required), 200 means logged in
        if [ "$scm_code" = "200" ] || [ "$scm_code" = "401" ] || [ "$scm_code" = "403" ]; then
          echo "‚úÖ SCM site ready (status: $scm_code)"
        else
          echo "‚ö†Ô∏è SCM site returned $scm_code - waiting 30s..."
          sleep 30
        fi

        echo "‚úÖ Pre-flight checks complete"

    - name: Deploy to Azure Web App
      run: |
        echo "üöÄ Deploying to ${{ env.AZURE_WEBAPP_NAME }}..."

        az webapp deploy \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.AZURE_WEBAPP_NAME }} \
          --src-path deploy.zip \
          --type zip \
          --async true

        echo ""
        echo "‚úÖ Deployment package uploaded!"
        echo "üìç Site: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
        echo ""
        echo "Note: Site will be available in ~1-2 minutes as container restarts"

    - name: Quick status check
      run: |
        echo "‚è≥ Waiting 20 seconds for deployment to register..."
        sleep 20

        # Single quick check - don't wait for full startup
        http_code=$(curl -s -o /dev/null -w "%{http_code}" \
          --connect-timeout 5 \
          --max-time 10 \
          https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health 2>/dev/null || echo "000")

        if [ "$http_code" = "200" ]; then
          echo "‚úÖ Site already healthy!"
        elif [ "$http_code" = "503" ] || [ "$http_code" = "502" ]; then
          echo "üîÑ Site restarting (expected) - will be ready in ~1 min"
        else
          echo "üì° Status: $http_code - deployment in progress"
        fi

    - name: Health check (optional)
      if: ${{ github.event.inputs.health_check == 'true' }}
      run: |
        echo "üè• Running full health check..."
        echo "Waiting 60 seconds for container startup..."
        sleep 60

        max_attempts=10
        attempt=1

        while [ $attempt -le $max_attempts ]; do
          echo "Health check attempt $attempt/$max_attempts..."

          http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            --max-time 30 \
            https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health 2>/dev/null || echo "000")

          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Site is healthy!"
            exit 0
          fi

          echo "Status: $http_code - waiting 20s..."
          sleep 20
          attempt=$((attempt + 1))
        done

        echo "‚ö†Ô∏è Health check timed out - site may still be starting"
        exit 0

    - name: Azure logout
      if: always()
      run: az logout
